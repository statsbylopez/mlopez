<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Statsbylopez on Statsbylopez</title>
    <link>/</link>
    <description>Recent content in Statsbylopez on Statsbylopez</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>&amp;copy; 2018</copyright>
    <lastBuildDate>Wed, 20 Apr 2016 00:00:00 +0000</lastBuildDate>
    <atom:link href="/" rel="self" type="application/rss+xml" />
    
    <item>
      <title>R for NFL analysis</title>
      <link>/post/r-for-nfl-analysis/</link>
      <pubDate>Fri, 10 May 2019 00:00:00 +0000</pubDate>
      
      <guid>/post/r-for-nfl-analysis/</guid>
      <description>&lt;div id=&#34;summary-of-today&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Summary of today&lt;/h2&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;p&gt;Tidyverse and NFL analytics&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Sample visualizations using &lt;code&gt;ggplot2&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Big Data Bowl insight&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div id=&#34;tidyverse-and-nfl-analytics&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Tidyverse and NFL analytics&lt;/h2&gt;
&lt;div id=&#34;packages&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Packages&lt;/h3&gt;
&lt;p&gt;Favorite packages to use for manipulation, tidying, data viz, analysis&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;code&gt;tidyverse&lt;/code&gt; : Data manipulation and graphing&lt;/li&gt;
&lt;li&gt;&lt;code&gt;lubridate&lt;/code&gt; : Handling dates&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ggbeeswarm&lt;/code&gt; : Fun plots&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ggridges&lt;/code&gt; : Fun plots&lt;/li&gt;
&lt;li&gt;&lt;code&gt;gganimate&lt;/code&gt; : Fun animations&lt;/li&gt;
&lt;li&gt;&lt;code&gt;tidyr&lt;/code&gt; : Tidy data (wide to long/long to wide)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;nflscrapr&lt;/code&gt; : Public win probabilities and expected points&lt;/li&gt;
&lt;li&gt;&lt;code&gt;caret&lt;/code&gt; : Machine learning tools&lt;/li&gt;
&lt;li&gt;&lt;code&gt;lme4&lt;/code&gt; : Statistical modeling&lt;/li&gt;
&lt;li&gt;&lt;code&gt;teamcolors&lt;/code&gt;: Team specific hex codes&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;#install.packages(&amp;quot;tidyverse&amp;quot;)
library(tidyverse) 
library(lubridate) 
library(beeswarm)  
library(gganimate) 
library(ggridges)  
library(tidyr)     &lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;reading-in-data&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Reading in data&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(tidyverse)
df_games &amp;lt;- read_csv(&amp;quot;prodb/dbo.Game.csv&amp;quot;)
df_plays &amp;lt;- read_csv(&amp;quot;prodb/dbo.VideoDirectorReport.csv&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;joining-data-sets&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Joining data sets&lt;/h3&gt;
&lt;p&gt;&lt;em&gt;Online cheat-sheet&lt;/em&gt;: &lt;a href=&#34;https://stat545.com/bit001_dplyr-cheatsheet.html&#34; class=&#34;uri&#34;&gt;https://stat545.com/bit001_dplyr-cheatsheet.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;left_join&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;inner_join&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;right_join&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;anti_join&lt;/code&gt;:&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;data-manipulation-using-the-tidyverse&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Data manipulation using the tidyverse&lt;/h3&gt;
&lt;p&gt;&lt;em&gt;Online cheat-sheet&lt;/em&gt;: &lt;a href=&#34;https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf&#34; class=&#34;uri&#34;&gt;https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Key commands:&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;select()&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;head()&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;tail()&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;filter()&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;df_plays_keep &amp;lt;- df_plays %&amp;gt;% 
  filter(HomeTeamFile == 1) %&amp;gt;% 
  select(GameKey, HomeClubCode, VisitorClubCode, Quarter, 
        PossessionTeam, PlayNullifiedByPenalty, 
        SpecialTeamsPlayType, PlayResult, Down, Distance, PlayDescription)
df_games &amp;lt;- df_games %&amp;gt;% select(GameKey, Season, Season_Type, Week, LeagueType)

df_plays_keep &amp;lt;- df_plays_keep %&amp;gt;% left_join(df_games, by = c(&amp;quot;GameKey&amp;quot; = &amp;quot;GameKey&amp;quot;))
df_plays_keep %&amp;gt;% head()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 6 x 15
##   GameKey HomeClubCode VisitorClubCode Quarter PossessionTeam
##     &amp;lt;int&amp;gt; &amp;lt;chr&amp;gt;        &amp;lt;chr&amp;gt;             &amp;lt;int&amp;gt; &amp;lt;chr&amp;gt;         
## 1     745 TEN          PIT                   2 TEN           
## 2     745 TEN          PIT                   2 TEN           
## 3     745 TEN          PIT                   4 PIT           
## 4     745 TEN          PIT                   4 PIT           
## 5     745 TEN          PIT                   4 PIT           
## 6     745 TEN          PIT                   4 PIT           
## # … with 10 more variables: PlayNullifiedByPenalty &amp;lt;chr&amp;gt;,
## #   SpecialTeamsPlayType &amp;lt;chr&amp;gt;, PlayResult &amp;lt;int&amp;gt;, Down &amp;lt;int&amp;gt;,
## #   Distance &amp;lt;int&amp;gt;, PlayDescription &amp;lt;chr&amp;gt;, Season &amp;lt;int&amp;gt;,
## #   Season_Type &amp;lt;chr&amp;gt;, Week &amp;lt;int&amp;gt;, LeagueType &amp;lt;chr&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;df_plays_keep %&amp;gt;% tail()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 6 x 15
##   GameKey HomeClubCode VisitorClubCode Quarter PossessionTeam
##     &amp;lt;int&amp;gt; &amp;lt;chr&amp;gt;        &amp;lt;chr&amp;gt;             &amp;lt;int&amp;gt; &amp;lt;chr&amp;gt;         
## 1   57464 NE           BUF                   3 BUF           
## 2   57469 SF           JAX                   2 JAX           
## 3   57466 NYJ          LAC                   1 LAC           
## 4   57462 CIN          DET                   4 DET           
## 5   57442 IND          DEN                   4 DEN           
## 6   57467 TEN          LA                    4 LA            
## # … with 10 more variables: PlayNullifiedByPenalty &amp;lt;chr&amp;gt;,
## #   SpecialTeamsPlayType &amp;lt;chr&amp;gt;, PlayResult &amp;lt;int&amp;gt;, Down &amp;lt;int&amp;gt;,
## #   Distance &amp;lt;int&amp;gt;, PlayDescription &amp;lt;chr&amp;gt;, Season &amp;lt;int&amp;gt;,
## #   Season_Type &amp;lt;chr&amp;gt;, Week &amp;lt;int&amp;gt;, LeagueType &amp;lt;chr&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;ol start=&#34;4&#34; style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;More &lt;code&gt;filter()&lt;/code&gt;: Categorical variables&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;df_plays_keep %&amp;gt;% 
  filter(Down == 4, Quarter == 1, Distance == 12, 
         PlayNullifiedByPenalty == &amp;quot;N&amp;quot;, SpecialTeamsPlayType == &amp;quot;NULL&amp;quot;) &lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 4 x 15
##   GameKey HomeClubCode VisitorClubCode Quarter PossessionTeam
##     &amp;lt;int&amp;gt; &amp;lt;chr&amp;gt;        &amp;lt;chr&amp;gt;             &amp;lt;int&amp;gt; &amp;lt;chr&amp;gt;         
## 1   26558 NE           BUF                   1 BUF           
## 2   29406 CLV          BUF                   1 BUF           
## 3   54993 CIN          NO                    1 CIN           
## 4   29772 GB           DET                   1 GB            
## # … with 10 more variables: PlayNullifiedByPenalty &amp;lt;chr&amp;gt;,
## #   SpecialTeamsPlayType &amp;lt;chr&amp;gt;, PlayResult &amp;lt;int&amp;gt;, Down &amp;lt;int&amp;gt;,
## #   Distance &amp;lt;int&amp;gt;, PlayDescription &amp;lt;chr&amp;gt;, Season &amp;lt;int&amp;gt;,
## #   Season_Type &amp;lt;chr&amp;gt;, Week &amp;lt;int&amp;gt;, LeagueType &amp;lt;chr&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;df_plays_keep &amp;lt;- df_plays_keep  %&amp;gt;% 
  filter(Season_Type == &amp;quot;Reg&amp;quot;, Season &amp;gt;= 2005, Season &amp;lt;= 2018, LeagueType == &amp;quot;NFL&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;What data set did we create?&lt;/strong&gt;&lt;/p&gt;
&lt;ol start=&#34;5&#34; style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;code&gt;arrange()&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;df_plays_keep %&amp;gt;% 
  filter(PossessionTeam == &amp;quot;MIN&amp;quot;, Season == 2018) %&amp;gt;% 
  arrange(-PlayResult) %&amp;gt;% 
  head()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 6 x 15
##   GameKey HomeClubCode VisitorClubCode Quarter PossessionTeam
##     &amp;lt;int&amp;gt; &amp;lt;chr&amp;gt;        &amp;lt;chr&amp;gt;             &amp;lt;int&amp;gt; &amp;lt;chr&amp;gt;         
## 1   57812 MIN          CHI                   2 MIN           
## 2   57586 GB           MIN                   4 MIN           
## 3   57607 MIN          BUF                   2 MIN           
## 4   57694 MIN          DET                   2 MIN           
## 5   57640 PHI          MIN                   3 MIN           
## 6   57668 NYJ          MIN                   3 MIN           
## # … with 10 more variables: PlayNullifiedByPenalty &amp;lt;chr&amp;gt;,
## #   SpecialTeamsPlayType &amp;lt;chr&amp;gt;, PlayResult &amp;lt;int&amp;gt;, Down &amp;lt;int&amp;gt;,
## #   Distance &amp;lt;int&amp;gt;, PlayDescription &amp;lt;chr&amp;gt;, Season &amp;lt;int&amp;gt;,
## #   Season_Type &amp;lt;chr&amp;gt;, Week &amp;lt;int&amp;gt;, LeagueType &amp;lt;chr&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;What plays are these?&lt;/strong&gt;?&lt;/p&gt;
&lt;ol start=&#34;6&#34; style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;code&gt;mutate()&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;df_plays_keep &amp;lt;- df_plays_keep %&amp;gt;% 
  mutate(is_first_down = PlayResult &amp;gt;= Distance, 
         scrimmage_play = SpecialTeamsPlayType == &amp;quot;NULL&amp;quot;)

df_plays_keep %&amp;gt;% 
  filter(PossessionTeam == &amp;quot;MIN&amp;quot;, Season == 2018, Down == 4, scrimmage_play, Quarter == 1) &lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 4 x 17
##   GameKey HomeClubCode VisitorClubCode Quarter PossessionTeam
##     &amp;lt;int&amp;gt; &amp;lt;chr&amp;gt;        &amp;lt;chr&amp;gt;             &amp;lt;int&amp;gt; &amp;lt;chr&amp;gt;         
## 1   57694 MIN          DET                   1 MIN           
## 2   57686 MIN          NO                    1 MIN           
## 3   57741 MIN          GB                    1 MIN           
## 4   57651 MIN          ARZ                   1 MIN           
## # … with 12 more variables: PlayNullifiedByPenalty &amp;lt;chr&amp;gt;,
## #   SpecialTeamsPlayType &amp;lt;chr&amp;gt;, PlayResult &amp;lt;int&amp;gt;, Down &amp;lt;int&amp;gt;,
## #   Distance &amp;lt;int&amp;gt;, PlayDescription &amp;lt;chr&amp;gt;, Season &amp;lt;int&amp;gt;,
## #   Season_Type &amp;lt;chr&amp;gt;, Week &amp;lt;int&amp;gt;, LeagueType &amp;lt;chr&amp;gt;, is_first_down &amp;lt;lgl&amp;gt;,
## #   scrimmage_play &amp;lt;lgl&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;What do these four plays represent?&lt;/strong&gt;&lt;/p&gt;
&lt;ol start=&#34;7&#34; style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;group_by()&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;summarize()&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;df_plays_keep %&amp;gt;% 
  filter(scrimmage_play, Season == 2018) %&amp;gt;% 
  group_by(PossessionTeam) %&amp;gt;% 
  summarise(ave_yds_gained = mean(PlayResult)) %&amp;gt;% 
  arrange(-ave_yds_gained) %&amp;gt;% 
  head()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 6 x 2
##   PossessionTeam ave_yds_gained
##   &amp;lt;chr&amp;gt;                   &amp;lt;dbl&amp;gt;
## 1 KC                       6.25
## 2 LA                       6.04
## 3 ATL                      5.78
## 4 PIT                      5.76
## 5 TB                       5.70
## 6 LAC                      5.67&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Identify the leaderboard above&lt;/strong&gt;:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;df_plays_keep %&amp;gt;% 
  filter(scrimmage_play) %&amp;gt;% 
  group_by(PossessionTeam, Season) %&amp;gt;% 
  summarise(ave_yds_gained = mean(PlayResult)) %&amp;gt;% 
  arrange(-ave_yds_gained) %&amp;gt;% 
  head()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 6 x 3
## # Groups:   PossessionTeam [6]
##   PossessionTeam Season ave_yds_gained
##   &amp;lt;chr&amp;gt;           &amp;lt;int&amp;gt;          &amp;lt;dbl&amp;gt;
## 1 ATL              2016           6.29
## 2 NO               2011           6.26
## 3 KC               2018           6.25
## 4 GB               2011           6.08
## 5 LA               2018           6.04
## 6 ARZ              2015           5.96&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Identify the leaderboard above&lt;/strong&gt;:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;df_plays_keep %&amp;gt;% 
  filter(scrimmage_play) %&amp;gt;% 
  group_by(PossessionTeam, Season) %&amp;gt;% 
  summarise(ave_yds_gained = mean(PlayResult)) %&amp;gt;% 
  arrange(-ave_yds_gained) %&amp;gt;% 
  tail()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 6 x 3
## # Groups:   PossessionTeam [5]
##   PossessionTeam Season ave_yds_gained
##   &amp;lt;chr&amp;gt;           &amp;lt;int&amp;gt;          &amp;lt;dbl&amp;gt;
## 1 HST              2005           3.81
## 2 CIN              2008           3.80
## 3 ARZ              2012           3.74
## 4 SF               2005           3.61
## 5 SF               2007           3.59
## 6 OAK              2006           3.50&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Identify the leaderboard above&lt;/strong&gt;:&lt;/p&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;data-visualization&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Data visualization&lt;/h2&gt;
&lt;div id=&#34;sample-q1-how-often-do-teams-go-for-it-on-4th-short-in-each-season&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Sample Q1: How often do teams go for it on 4th-short in each season?&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;fourth_down_rates &amp;lt;- df_plays_keep %&amp;gt;% 
  filter(Down == 4, Distance &amp;lt;= 2) %&amp;gt;% 
  group_by(PossessionTeam, Season) %&amp;gt;% 
  summarise(go_forit_rate = mean(scrimmage_play), 
            n_chances = n())


fourth_down_rates %&amp;gt;% 
  arrange(-go_forit_rate) %&amp;gt;% 
  head()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 6 x 4
## # Groups:   PossessionTeam [6]
##   PossessionTeam Season go_forit_rate n_chances
##   &amp;lt;chr&amp;gt;           &amp;lt;int&amp;gt;         &amp;lt;dbl&amp;gt;     &amp;lt;int&amp;gt;
## 1 JAX              2013         0.692        26
## 2 BUF              2018         0.688        16
## 3 NE               2007         0.682        22
## 4 CLV              2017         0.667        15
## 5 MIN              2018         0.654        26
## 6 BLT              2018         0.65         20&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;fourth_down_rates %&amp;gt;% 
  arrange(go_forit_rate) %&amp;gt;% 
  head()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 6 x 4
## # Groups:   PossessionTeam [6]
##   PossessionTeam Season go_forit_rate n_chances
##   &amp;lt;chr&amp;gt;           &amp;lt;int&amp;gt;         &amp;lt;dbl&amp;gt;     &amp;lt;int&amp;gt;
## 1 BUF              2012        0.05          20
## 2 CIN              2007        0.0526        19
## 3 SL               2015        0.0588        17
## 4 CAR              2006        0.0714        28
## 5 ATL              2012        0.0938        32
## 6 MIN              2005        0.1           30&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(ggbeeswarm)
fourth_down_rates %&amp;gt;% 
  ggplot(aes(x = Season, y = go_forit_rate, fill = go_forit_rate)) + 
  geom_quasirandom(pch = 21, size = 3) + 
  scale_fill_viridis_c(&amp;quot;&amp;quot;,  guide = FALSE) + 
  theme_classic(15) +  
  scale_x_continuous(labels = 2005:2018, breaks = 2005:2018) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(title = &amp;quot;Go-for-it rate, 4th-1 or 4th-2&amp;quot;, y = &amp;quot;&amp;quot;, x = &amp;quot;&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/2019-05-10-r-for-nfl-analysis_files/figure-html/unnamed-chunk-11-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;sample-q2-whats-going-on-on-the-punt-play&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Sample Q2: What’s going on on the punt play?&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;df_punts_keep &amp;lt;- df_plays %&amp;gt;% 
  filter(HomeTeamFile == 1, SpecialTeamsPlayType == &amp;quot;Punt&amp;quot;|SpecialTeamsPlayType == &amp;quot;Punt Return&amp;quot;) %&amp;gt;% 
  select(GameKey, HomeClubCode, VisitorClubCode, Quarter, KickoffResult,
        PossessionTeam, PlayNullifiedByPenalty, 
        SpecialTeamsPlayType, PlayResult, Down, Distance, PlayDescription)

df_punts_keep &amp;lt;- df_punts_keep %&amp;gt;% left_join(df_games, by = c(&amp;quot;GameKey&amp;quot; = &amp;quot;GameKey&amp;quot;))

## Penalty rate on punt plays using `grepl`
df_punts_keep %&amp;gt;% 
  mutate(is_penalty = grepl(&amp;quot;PENALTY&amp;quot;, PlayDescription)) %&amp;gt;% 
  summarise(p_rate = mean(is_penalty))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 1 x 1
##   p_rate
##    &amp;lt;dbl&amp;gt;
## 1  0.138&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;df_punts_keep %&amp;gt;% 
  filter(Season &amp;gt;= 2001) %&amp;gt;% 
  ggplot(aes(Season, fill = KickoffResult)) + 
  geom_bar(position = &amp;quot;fill&amp;quot;) + 
  scale_fill_brewer(palette = &amp;quot;Set1&amp;quot;) + 
  scale_y_continuous(labels = scales::percent, &amp;quot;Rate&amp;quot;) + 
  labs(title = &amp;quot;Punt outcomes over time&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/2019-05-10-r-for-nfl-analysis_files/figure-html/unnamed-chunk-12-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;other-charts-of-interest&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Other charts of interest&lt;/h3&gt;
&lt;div id=&#34;examples-from-league-office&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;Examples from league office&lt;/h4&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Tyler Lockett funnel plot&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&#34;/Users/mlopez1/Dropbox/NFL_Random_Pats/lockett.png&#34; width=&#34;550px&#34; /&gt;&lt;/p&gt;
&lt;ol start=&#34;2&#34; style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Maps&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&#34;/Users/mlopez1/Dropbox/NFL_Random_Pats/hex_college.PNG&#34; width=&#34;550px&#34; /&gt;&lt;/p&gt;
&lt;ol start=&#34;3&#34; style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Team logos with &lt;code&gt;ggimage&lt;/code&gt;: &lt;a href=&#34;https://statsbylopez.netlify.com/post/nfl-team-logos-using-ggimage/&#34;&gt;link&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&#34;/Users/mlopez1/Dropbox/NFL_Random_Pats/ggimage.png&#34; width=&#34;550px&#34; /&gt;&lt;/p&gt;
&lt;ol start=&#34;4&#34; style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Competition committee work: resampling plays to estimate overtime outcomes&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&#34;/Users/mlopez1/Dropbox/NFL_Random_Pats/drive_sim.PNG&#34; width=&#34;650px&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;what-can-we-do-with-next-gen-stats&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;What can we do with Next Gen Stats?&lt;/h3&gt;
&lt;p&gt;General processes for NGS data&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Start small. Identify play-type of interest and find 5-10 examples using &lt;code&gt;playId&lt;/code&gt;/&lt;code&gt;gameId&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Scrape data using &lt;a href=&#34;https://docs.ngs.nfl.com&#34; class=&#34;uri&#34;&gt;https://docs.ngs.nfl.com&lt;/a&gt; and personal credentials&lt;/li&gt;
&lt;li&gt;Build animation/summary metrics within the sample of plays&lt;/li&gt;
&lt;li&gt;Re-center data using &lt;code&gt;playDirection&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Re-orgin data using location where (player/ball) started&lt;/li&gt;
&lt;li&gt;Cross-check with video&lt;/li&gt;
&lt;li&gt;Expand across larger sample of plays&lt;/li&gt;
&lt;li&gt;Sample large sample of plays to cross-check for accuracy&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div id=&#34;play-animation&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Play animation&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;file_tracking &amp;lt;- &amp;quot;https://raw.githubusercontent.com/nfl-football-ops/Big-Data-Bowl/master/Data/tracking_gameId_2017090700.csv&amp;quot;
tracking_example &amp;lt;- read_csv(file_tracking)

file_game &amp;lt;- &amp;quot;https://raw.githubusercontent.com/nfl-football-ops/Big-Data-Bowl/master/Data/games.csv&amp;quot;
games_sum &amp;lt;- read_csv(file_game) 

file_plays &amp;lt;- &amp;quot;https://raw.githubusercontent.com/nfl-football-ops/Big-Data-Bowl/master/Data/plays.csv&amp;quot;
plays_sum &amp;lt;- read_csv(file_plays) 

tracking_example_merged &amp;lt;- tracking_example %&amp;gt;% inner_join(games_sum) %&amp;gt;% inner_join(plays_sum) 

example_play &amp;lt;- tracking_example_merged %&amp;gt;% filter(playId == 938)
example_play %&amp;gt;% select(playDescription) %&amp;gt;% slice(1)

library(gganimate)
library(cowplot)

## General field boundaries
xmin &amp;lt;- 0
xmax &amp;lt;- 160/3
hash.right &amp;lt;- 38.35
hash.left &amp;lt;- 12
hash.width &amp;lt;- 3.3


## Specific boundaries for a given play
ymin &amp;lt;- max(round(min(example_play$x, na.rm = TRUE) - 10, -1), 0)
ymax &amp;lt;- min(round(max(example_play$x, na.rm = TRUE) + 10, -1), 120)
df_hash &amp;lt;- expand.grid(x = c(0, 23.36667, 29.96667, xmax), y = (10:110))
df_hash &amp;lt;- df_hash %&amp;gt;% filter(!(floor(y %% 5) == 0))
df_hash &amp;lt;- df_hash %&amp;gt;% filter(y &amp;lt; ymax, y &amp;gt; ymin)

animate_play &amp;lt;- ggplot() +
  scale_size_manual(values = c(6, 4, 6), guide = FALSE) + 
  scale_shape_manual(values = c(21, 16, 21), guide = FALSE) +
  scale_fill_manual(values = c(&amp;quot;#e31837&amp;quot;, &amp;quot;#654321&amp;quot;, &amp;quot;#002244&amp;quot;), guide = FALSE) + 
  scale_colour_manual(values = c(&amp;quot;black&amp;quot;, &amp;quot;#654321&amp;quot;, &amp;quot;#c60c30&amp;quot;), guide = FALSE) + 
  annotate(&amp;quot;text&amp;quot;, x = df_hash$x[df_hash$x &amp;lt; 55/2], 
           y = df_hash$y[df_hash$x &amp;lt; 55/2], label = &amp;quot;_&amp;quot;, hjust = 0, vjust = -0.2) + 
  annotate(&amp;quot;text&amp;quot;, x = df_hash$x[df_hash$x &amp;gt; 55/2], 
           y = df_hash$y[df_hash$x &amp;gt; 55/2], label = &amp;quot;_&amp;quot;, hjust = 1, vjust = -0.2) + 
  annotate(&amp;quot;segment&amp;quot;, x = xmin, 
           y = seq(max(10, ymin), min(ymax, 110), by = 5), 
           xend =  xmax, 
           yend = seq(max(10, ymin), min(ymax, 110), by = 5)) + 
  annotate(&amp;quot;text&amp;quot;, x = rep(hash.left, 11), y = seq(10, 110, by = 10), 
                    label = c(&amp;quot;G   &amp;quot;, seq(10, 50, by = 10), rev(seq(10, 40, by = 10)), &amp;quot;   G&amp;quot;), 
                    angle = 270, size = 4) + 
  annotate(&amp;quot;text&amp;quot;, x = rep((xmax - hash.left), 11), y = seq(10, 110, by = 10), 
           label = c(&amp;quot;   G&amp;quot;, seq(10, 50, by = 10), rev(seq(10, 40, by = 10)), &amp;quot;G   &amp;quot;), 
           angle = 90, size = 4) + 
  annotate(&amp;quot;segment&amp;quot;, x = c(xmin, xmin, xmax, xmax), 
           y = c(ymin, ymax, ymax, ymin), 
           xend = c(xmin, xmax, xmax, xmin), 
           yend = c(ymax, ymax, ymin, ymin), colour = &amp;quot;black&amp;quot;) + 
  geom_point(data = example_play, aes(x = (xmax-y), y = x, shape = team,
                                 fill = team, group = nflId, size = team, colour = team), alpha = 0.7) + 
  geom_text(data = example_play, aes(x = (xmax-y), y = x, label = jerseyNumber), colour = &amp;quot;white&amp;quot;, 
            vjust = 0.36, size = 3.5) + 
  ylim(ymin, ymax) + 
  coord_fixed() +  
  theme_nothing() + 
  transition_time(frame.id)  +
  ease_aes(&amp;#39;linear&amp;#39;) + 
  NULL

## Ensure timing of play matches 10 frames-per-second
play.length.ex &amp;lt;- length(unique(example.play$frame.id))
#animate(animate.play, fps = 10, nframe = play.length.ex)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/Users/mlopez1/Dropbox/NFL_Random_Pats/kc_ne.gif&#34; width=&#34;500px&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;target-maps&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Target maps&lt;/h3&gt;
&lt;p&gt;&lt;em&gt;Shiny app built in R&lt;/em&gt;: &lt;a href=&#34;https://www.cmusportsanalytics.com/introduction-to-next-gen-scrapy/&#34; class=&#34;uri&#34;&gt;https://www.cmusportsanalytics.com/introduction-to-next-gen-scrapy/&lt;/a&gt;, &lt;a href=&#34;https://sarahmallepalle.shinyapps.io/next-gen-scrapy/&#34; class=&#34;uri&#34;&gt;https://sarahmallepalle.shinyapps.io/next-gen-scrapy/&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;win-probability&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Win probability&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;/Users/mlopez1/Dropbox/NFL_Random_Pats/no_pit.gif&#34; width=&#34;500px&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;spray-chartsqb-paths&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Spray charts/qb paths&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;/Users/mlopez1/Dropbox/NFL_Random_Pats/passes_mahomes.gif&#34; width=&#34;500px&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;rb-locations&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;RB locations&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;/Users/mlopez1/Dropbox/NFL_Random_Pats/bell.PNG&#34; width=&#34;500px&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;big-data-bowl&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Big Data Bowl&lt;/h2&gt;
&lt;div id=&#34;background&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Background&lt;/h3&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;p&gt;Football Ops website with rules and winners: &lt;a href=&#34;https://operations.nfl.com/the-game/big-data-bowl/&#34; class=&#34;uri&#34;&gt;https://operations.nfl.com/the-game/big-data-bowl/&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;(Static) Github page that hosted the data: &lt;a href=&#34;https://github.com/nfl-football-ops/Big-Data-Bowl&#34; class=&#34;uri&#34;&gt;https://github.com/nfl-football-ops/Big-Data-Bowl&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Forthcoming link: each submission, linked with participants and select resumes&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div id=&#34;sample-entries-and-code&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Sample entries and code:&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Kyle Burris:&lt;a href=&#34;https://github.com/burrisk/Big-Data-Bowl&#34; class=&#34;uri&#34;&gt;https://github.com/burrisk/Big-Data-Bowl&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;/Users/mlopez1/Dropbox/NFL_Random_Pats/burris.gif&#34; width=&#34;400px&#34; /&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SFU college:&lt;a href=&#34;https://operations.nfl.com/media/3670/big-data-bowl-sfu.pdf&#34; class=&#34;uri&#34;&gt;https://operations.nfl.com/media/3670/big-data-bowl-sfu.pdf&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;/Users/mlopez1/Dropbox/NFL_Random_Pats/sfu.PNG&#34; width=&#34;600px&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Estimating NFL drive outcomes under rules that don&#39;t exist</title>
      <link>/post/resampling-nfl-drives/</link>
      <pubDate>Mon, 06 May 2019 00:00:00 +0000</pubDate>
      
      <guid>/post/resampling-nfl-drives/</guid>
      <description>&lt;p&gt;&lt;strong&gt;How do you estimate outcomes under a set of rules that don’t (yet) exist?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;In this post, I’ll walk through how the NFL league office used resampling to estimate metrics related to an offseason proposal related to overtime.&lt;/p&gt;
&lt;div id=&#34;background&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Background&lt;/h2&gt;
&lt;p&gt;Back in March, the NFL’s competition committee and owners debated the merits of a rule change, proposed by &lt;a href=&#34;https://operations.nfl.com/updates/football-ops/2019-playing-rules-proposals/&#34;&gt;Kansas City&lt;/a&gt;, that would allow both teams the opportunity to possess the ball at least one time in overtime. This would create a scenario unlike any other in football. If the game starts with an opening drive touchdown, the receiving team would:&lt;/p&gt;
&lt;ol style=&#34;list-style-type: lower-roman&#34;&gt;
&lt;li&gt;Need a touchdown to extend the game&lt;/li&gt;
&lt;li&gt;Never punt&lt;/li&gt;
&lt;li&gt;Never attempt a field goal&lt;/li&gt;
&lt;li&gt;Not care much about the clock&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Points (ii) and (iii) are key. It is not uncommon for teams to need a touchdown when trailing late, but in those situations, a number of other factors also play a role in decision making, including timeouts, team quality, and game clock.&lt;/p&gt;
&lt;p&gt;In overtime, meanwhile, a team needing a touchdown would never punt or kick a field goal. &lt;em&gt;So how often would they score a touchdown?&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;resampling-plays&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Resampling plays&lt;/h2&gt;
&lt;p&gt;We’ll need more granular data than drive outcomes to estimate touchdown likelihood. So, let’s use plays.&lt;/p&gt;
&lt;p&gt;One possibility would be to estimate a conditional distribution of play outcomes given down, distance, and field position. That is, given play-level characteristics, estimate the likelihood of gaining certain yardage on the next play. Using that, one could build a drive simulator.&lt;/p&gt;
&lt;p&gt;But football’s not that easy. Once you modeled yardage gained, you’d realize you should have started with modeling turnover likelihood. Once you model turnover likelihood, you’d realize you should have started with penalty likelihood. And once you modeled penalty likelihood, you’d realize you should have built a model to estimate where the drive would start in the first place. Basically, a statistics version of &lt;a href=&#34;https://en.wikipedia.org/wiki/If_You_Give_a_Mouse_a_Cookie&#34;&gt;“If you give a mouse a cookie”&lt;/a&gt;. You could also model a joint distribution here, but, at this point, that’s an area for future work.&lt;/p&gt;
&lt;p&gt;In absence of building several such models, a second, simpler approach would use the observed set of plays and some resampling. That is, at each down, distance, and yard line, we’ll sample from the empirical distribution of similar plays to simulate a play that could happen.&lt;/p&gt;
&lt;p&gt;Here’s a version of what this looks. Given that our internal data is a slightly more enhanced than what’s out there publicly, for this post I modified our code to accomodate the public play-by-play data from &lt;a href=&#34;https://github.com/maksimhorowitz/nflscrapR&#34;&gt;nflscrapr&lt;/a&gt;. Each of these plays are stored in a data frame &lt;code&gt;scrapr.plays&lt;/code&gt;, grabbed using code &lt;a href=&#34;https://github.com/statsbylopez/BlogPosts/blob/master/scrapr-data.R&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;div id=&#34;pre-processing&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Pre-processing&lt;/h3&gt;
&lt;p&gt;First, to ensure team motivations roughly fall in line with those participating in an overtime game, I’ll strip the entire set of NFL plays into scrimmage plays run in one possession games, outside of the last two minutes of each half. I also drop two-point conversions, create indicator for whether a fumble or interception occured (&lt;code&gt;is.turnover&lt;/code&gt;), whether an offensive (&lt;code&gt;is.td.offense&lt;/code&gt;) touchdown occured, and add a variable for line-of-scrimmage (yards from own goal, or &lt;code&gt;yfog&lt;/code&gt;).&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(tidyverse)
scrapr.plays &amp;lt;- read_csv(&amp;quot;scrapr_plays.csv&amp;quot;)

df.scrimmage &amp;lt;- scrapr.plays %&amp;gt;% 
  filter(play_type == &amp;quot;pass&amp;quot;|play_type == &amp;quot;run&amp;quot;, half_seconds_remaining &amp;gt;= 120) %&amp;gt;% 
  mutate(p.diff = total_home_score - total_away_score, 
         is.two.point = grepl(&amp;quot;TWO-POINT CONVERSION&amp;quot;, desc), 
         is.fumble = !is.na(fumble_recovery_1_team), 
         is.turnover = grepl(&amp;quot;INTERCEPTED&amp;quot;, desc)|(is.fumble &amp;amp; fumble_recovery_1_team!=posteam), 
         is.td.offense = rush_touchdown|pass_touchdown, 
         yfog = 100 - yardline_100) %&amp;gt;% 
  filter(abs(p.diff) &amp;lt;= 8, !is.two.point, 
         !is.na(yards_gained))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;sampling-plays&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Sampling plays&lt;/h3&gt;
&lt;p&gt;Next, I write a function, &lt;code&gt;sample.rp.drive.needs.TD&lt;/code&gt;, to sample &lt;code&gt;df.scrimmage&lt;/code&gt; based on down, distance, and line of scrimmage. The code for that is &lt;a href=&#34;https://github.com/statsbylopez/BlogPosts/blob/master/scrapr-data.R&#34;&gt;here&lt;/a&gt;. Given that 1st-10 plays from midfield are similar to 1st-10 plays from, say, the 47-yard line, the sampling process gives a bit of wiggle room around yard line to increase the number of plays available at each down and distance. In this example, I use +/- 3 yards, +/- 2 yards, +/- 1 yard, and 0 yards for (1-70), (71-90), (91-97), and (98-99) yards-from-own-goal intervals, respectively. I don’t want to add three yards when a team has 3rd-goal from the one, but I’m okay sampling a 3rd-5 play from the 40 yard-line when a team is actually at the 42. To allow for larger samples of plays, 4th-down plays are treated as 3rd-downs.&lt;/p&gt;
&lt;p&gt;As an example, here’s the type of outcome you’d get from the function above. On one 1st-10, Mitchell Trubisky hits Taylor Gabriel for a 54-yard catch! On the next, Joe Flacco is picked off by Steve Gregory.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;sample.play &amp;lt;- sample.rp.drive.needs.TD(down = 1, yards.to.go = 10, yards.from.own.goal = 25)
sample.play$play&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] (7:50) (Shotgun) M.Trubisky pass deep left to T.Gabriel to MIA 21 for 54 yards (T.McTyer).
## Levels: (7:50) (Shotgun) M.Trubisky pass deep left to T.Gabriel to MIA 21 for 54 yards (T.McTyer).&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;sample.play &amp;lt;- sample.rp.drive.needs.TD(down = 1, yards.to.go = 10, yards.from.own.goal = 25)
sample.play$play&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] (7:42) J.Flacco pass deep middle intended for D.Pitta INTERCEPTED by S.Gregory at BAL 42. S.Gregory to BAL 6 for 36 yards (R.Rice).
## Levels: (7:42) J.Flacco pass deep middle intended for D.Pitta INTERCEPTED by S.Gregory at BAL 42. S.Gregory to BAL 6 for 36 yards (R.Rice).&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;sampling-entire-drives&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Sampling entire drives&lt;/h3&gt;
&lt;p&gt;We’ll want to iteratively build out drives, so that after each play, the offensive team continues to try and move down the field. After Gabriel’s catch above, for example, the offense would have 1st-10 from the opponent 21-yard line. Note that for simplicity in this post, I’ll assume each drive started at a team’s 25-yard line – in overtime, roughly 70% of drives start here.&lt;/p&gt;
&lt;p&gt;The key part of the loop below is the &lt;code&gt;while()&lt;/code&gt; command: we continue to sample plays until (i) a turnover (ii) an offensive touchdown or (iii) a team goes for it on 4th-down and fails, any of which would formally signal the end of the drive (&lt;code&gt;end.of.drive&lt;/code&gt;).&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;set.seed(0)
all.drives.store &amp;lt;- NULL
n.sim &amp;lt;- 10000
yfog.start &amp;lt;- 25
for (i in 1:n.sim){
  drive.store &amp;lt;- NULL
  new.down &amp;lt;- 1
  new.distance &amp;lt;- 10
  new.yfog &amp;lt;- yfog.start
  end.of.drive &amp;lt;- FALSE
  play.num &amp;lt;- 1
  while (!end.of.drive){
    run.play &amp;lt;- sample.rp.drive.needs.TD(down = new.down, 
                                         yards.to.go = new.distance, 
                                         yards.from.own.goal = new.yfog)
    run.play$play.num &amp;lt;- play.num
    drive.store &amp;lt;- bind_rows(drive.store, run.play)
    new.down &amp;lt;- run.play$new.down
    new.distance &amp;lt;- run.play$new.distance
    new.yfog &amp;lt;- run.play$new.yfog
    end.of.drive &amp;lt;- run.play$end.drive
    play.num &amp;lt;- play.num + 1
    drive.store
  }
  i &amp;lt;- i + 1
  drive.store$sim.id &amp;lt;- i
  drive.store
  
  if (i %% 100 == 0){print(i)}
  all.drives.store &amp;lt;- bind_rows(all.drives.store, drive.store)
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;what-a-simulated-drive-looks-like&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;What a simulated drive looks like&lt;/h3&gt;
&lt;p&gt;Here’s one sampled drive. It starts with an Andy Dalton pass on 1st-10, and ends a few plays later with a long pass to Dez Bryant. Keep in mind that this &lt;em&gt;should&lt;/em&gt; look weird – we’re sampling plays across the last decade of play, and will jump back and forth between offenses.
&lt;img src=&#34;/post/2019-05-06-resampling-nfl-drives_files/figure-html/unnamed-chunk-6-1.png&#34; width=&#34;768&#34; /&gt;&lt;/p&gt;
&lt;p&gt;More importantly, this particular drive shows the importance of replicating what &lt;strong&gt;could&lt;/strong&gt; happen in overtime. Above, the offense went for it on 4th-2 in its own territory, a Mike Gillislee run that is shown in red. In a typical game, most teams in this situation would have punted the ball away. By being forced to be aggressive, what was otherwise a likely punt became a touchdown.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;aggregating-across-drives&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Aggregating across drives&lt;/h3&gt;
&lt;p&gt;So, how often would an offense score a touchdown in overtime? Here’s a plot of drive outcomes. Each of the 10,000 simulations is a dot, and about 3 of every 10 dots signify an offensive touchdown. In other words, when needing a touchdown and a touchdown only, an offense will score on about 30% of its drives.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/post/2019-05-06-resampling-nfl-drives_files/figure-html/unnamed-chunk-7-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;How’s this compare to non-overtime drives? Well, teams score a touchdown on the first drive of overtime about 20% of the time, which is roughly what matches the first drive of the &lt;a href=&#34;https://twitter.com/StatsbyLopez/status/1118236788974342146&#34;&gt;game&lt;/a&gt;. In other words, the &lt;em&gt;need&lt;/em&gt; to score a touchdown increases a team’s chance of scoring that touchdown by about a factor of 1.5.&lt;/p&gt;
&lt;p&gt;But wait, there’s more.&lt;/p&gt;
&lt;p&gt;The above simulation dodges a few things that complicate football drives, most notably penalties. In our work at the league office, we got a number closer to 40% than 30%. That is, when you add in penalties, which tend to help the offense more than they help the defense, you’ll likely get a rate higher than the 30% I got above. Additionally, changes to the game (recently, more passing) and potential changes in third-down behavior (perhaps teams would run more if they know they are going to go for it?) are two weaknesses that jump out in the above approach.&lt;/p&gt;
&lt;p&gt;For now, however, hopefully this gives you a sense of how resampling helped project rules in NFL games that don’t exist. In our case, we sampled from the empirical distribution of actual plays to simulate an offense moving down the field in overtime. Given the forced aggressiveness, we identified a touchdown scoring rate that we could use to better assess what could happen under a rules proposal that would change how NFL overtimes work.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>In an NHL game, the next penalty is easier to predict than the next goal</title>
      <link>/post/next-nhl-event/</link>
      <pubDate>Fri, 19 Apr 2019 00:00:00 +0000</pubDate>
      
      <guid>/post/next-nhl-event/</guid>
      <description>&lt;p&gt;It&amp;rsquo;s NHL playoff season, which means that, given the relative &lt;a href=&#34;https://arxiv.org/abs/1701.05976&#34; target=&#34;_blank&#34;&gt;league parity&lt;/a&gt;, every call and no-call comes under a microscope. In the third period of close games, for example, a penalty call alone can decrease a team&amp;rsquo;s chance of winning by &lt;a href=&#34;http://moneypuck.com/g.htm?id=2018030174&#34; target=&#34;_blank&#34;&gt;10 percentage points&lt;/a&gt; or more.&lt;/p&gt;

&lt;p&gt;One characteristic of NHL games that a few prominent members of the media &lt;a href=&#34;https://twitter.com/domluszczyszyn/status/1116450841022488576&#34; target=&#34;_blank&#34;&gt;have picked up on&lt;/a&gt; is that penalty calls tend to &amp;ldquo;even-up&amp;rdquo; within a game &amp;ndash; that is, it is unlikely that either team ends the game with a substantially larger number of penalties than its opponent. &lt;a href=&#34;https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2259798&#34; target=&#34;_blank&#34;&gt;Kevin and I&lt;/a&gt;, as well as a few others (&lt;a href=&#34;http://people.stat.sfu.ca/~tim/papers/penalty.pdf&#34; target=&#34;_blank&#34;&gt;ex 1&lt;/a&gt;, &lt;a href=&#34;https://www.researchgate.net/publication/274325288_Reversal_of_Fortune_A_Statistical_Analysis_of_Penalty_Calls_in_the_National_Hockey_League&#34; target=&#34;_blank&#34;&gt;ex 2&lt;/a&gt;), have covered this in depth over the last few years.&lt;/p&gt;

&lt;p&gt;But a fun comparison I thought to make would be that, instead of the analyzing the impact of penalty differential alone, let&amp;rsquo;s compare penalty likelihood to goal likelihood. That is, given goal and penalty information from earlier in the game, compare the chance that the next goal is scored by the home team to the chance that the next penalty is called on the home team.&lt;/p&gt;

&lt;p&gt;Using all games from 2005-2016, here&amp;rsquo;s the likelihood that (i) the first penalty of the second period is called on the home team (left plot) and (ii) the first goal of the second period is scored by the home team (right plot), given both the goal and penalty differentials in the first period. Goal and penalty differentials are given relative to the home team.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/img/nhlpens.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Two aspects stand out.&lt;/p&gt;

&lt;p&gt;First, the rates shown in the penalty plot are both more extreme and show more consistent of a pattern than in the goal plot. If you want to predict the first penalty of the second period, that&amp;rsquo;s likely an easier task than predicting the first goal. Second, many of the differences in the goal plot are driven not by goal differential, but by penalty differential. In the goal plot, the pattern looking left to right seems stronger than the pattern looking bottom to top. Thinking more broadly, we&amp;rsquo;ve long known that score effects impact NHL team behavior &amp;ndash; I wonder if part of this is due to the fact that score effects are somewhat of a proxy for penalty differential.&lt;/p&gt;

&lt;p&gt;Technical postscripts:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;I stopped after the 2016 only because I don&amp;rsquo;t have a clean pbp data-set to match the &lt;a href=&#34;https://cran.r-project.org/src/contrib/Archive/nhlscrapr/&#34; target=&#34;_blank&#34;&gt;nhlscrapR&lt;/a&gt; version I used before. If anyone wants to update, I&amp;rsquo;d be curious to see the results. A comparison of regular and postseason games could also be warranted.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;A smart observer would point out that one could improve a goal prediction model by including characteristics of each team, whereas including those same factors is unlikely to have as much of an impact on a penalty prediction model. Perhaps a future post.&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
</description>
    </item>
    
    <item>
      <title>NFL team logos using ggimage</title>
      <link>/post/nfl-team-logos-using-ggimage/</link>
      <pubDate>Thu, 25 Oct 2018 00:00:00 +0000</pubDate>
      
      <guid>/post/nfl-team-logos-using-ggimage/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://twitter.com/bburkeESPN/status/1055150920340774912&#34;&gt;Brian&lt;/a&gt;, &lt;a href=&#34;https://twitter.com/abresler/status/1055446174730240000&#34;&gt;Alex&lt;/a&gt;, and a host of others have done nice work recently when it comes to creating better scatter plots using images in &lt;code&gt;ggplot&lt;/code&gt; in &lt;a href=&#34;https://cran.r-project.org/&#34;&gt;R&lt;/a&gt;. In this post, I’ll show how easy it is to use the &lt;code&gt;ggimage&lt;/code&gt; package and do the same.&lt;/p&gt;
&lt;div id=&#34;what-data-to-use&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;What data to use?&lt;/h2&gt;
&lt;p&gt;Ron, Sam, Max, and the folks at &lt;a href=&#34;https://github.com/maksimhorowitz/nflscrapR&#34;&gt;nflscrapR&lt;/a&gt; have built a pretty amazing tool to analyze football play-by-play data. They’ve nicely stored csv’s that summarize several play-level and team-level characteristics relating to each play. In my example, I’ll use this data to contrast team run and pass performance, as measured through expected points added. For more on expected points, see Trey’s series &lt;a href=&#34;http://thespread.us/expected-points.html&#34;&gt;here&lt;/a&gt;, or the nfl WAR paper &lt;a href=&#34;https://arxiv.org/abs/1802.00998&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;First, we read in the data, and create what would be a typical plot that highlights run and pass performance for each offense.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(RCurl)
library(tidyverse)
library(ggrepel)
url.18 &amp;lt;- getURL(&amp;quot;https://raw.githubusercontent.com/ryurko/nflscrapR-data/master/play_by_play_data/regular_season/reg_pbp_2018.csv&amp;quot;)
pbp &amp;lt;- read.csv(text = url.18)
scrimmage.plays &amp;lt;- pbp %&amp;gt;% filter(play_type == &amp;quot;pass&amp;quot;|play_type == &amp;quot;run&amp;quot;)
scrimmage.plays.summary &amp;lt;- scrimmage.plays %&amp;gt;% 
  group_by(posteam, play_type) %&amp;gt;% 
  summarise(ave.epa = mean(epa, na.rm = TRUE)) %&amp;gt;%
  spread(play_type, ave.epa)

bound.label &amp;lt;- 0.38
df.text &amp;lt;- data.frame(lab.text = c(&amp;quot;Run +, Pass -&amp;quot;, &amp;quot;Run +, Pass +&amp;quot;, &amp;quot;Run -, Pass +&amp;quot;, &amp;quot;Run -, Pass -&amp;quot;), 
                      x = c(bound.label, bound.label, -1*bound.label, -1*bound.label), 
                      y = c(-1*bound.label, bound.label, bound.label, -1*bound.label))

ggplot(scrimmage.plays.summary, aes(run, pass, label = posteam)) + 
  geom_point() + 
  geom_text_repel() + 
  xlab(&amp;quot;Run: average offensive EPA&amp;quot;) + 
  ylab(&amp;quot;Pass: average offensive EPA&amp;quot;) + 
  theme_minimal() + 
  labs(title = &amp;quot;Offensive performance, 2018 season&amp;quot;, subtitle = &amp;quot;Data courtesy: nflscrapR&amp;quot;) + 
  geom_hline(aes(yintercept = 0), lty = 2, col = &amp;quot;red&amp;quot;, alpha = 0.5)+ 
  geom_vline(aes(xintercept = 0), lty = 2, col = &amp;quot;red&amp;quot;, alpha = 0.5) + 
  xlim(c(-0.45, 0.45)) + ylim(c(-0.45, 0.45)) + 
  geom_text(data = df.text, aes(x, y, label = lab.text), colour = &amp;quot;red&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/2018-10-25-nfl-team-logos-using-ggimage_files/figure-html/unnamed-chunk-1-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;There’s a bunch that can be gleamed from the chart above. As one example, the team-to-team variability in average pass EPA is greater than that of the team-to-team variability in average rush EPA. As another, 23 of 32 teams boast a greater-than-0 average pass EPA, compared to 14 of 32 teams that have an average rush EPA greater than 0. This doesn’t exactly mean teams should pass more – averages are impacted by skewness, and the distribution of play-level EPA on passes is strongly skewed right.&lt;/p&gt;
&lt;p&gt;None of these findings are particularly new, however, and to date, there is a large amount of literature regarding the run versus pass debate. In fact, there’s someone who has probably already made the exact graph above.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;adding-in-team-logos&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Adding in team logos&lt;/h2&gt;
&lt;p&gt;It’s perhaps more visually appealing to use team logos (or helmets) in place of three letter team codes. For ages, adding images to &lt;code&gt;ggplot&lt;/code&gt; R graphs required the use of several lines of code: using the &lt;code&gt;ggimage&lt;/code&gt; package, that process is (fortunately) no longer needed.&lt;/p&gt;
&lt;p&gt;In the code below, I link to a file (eventually stored as &lt;code&gt;df.logos&lt;/code&gt;) that has up-to-date NFL logos (drawn via Wikipedia png’s), and merge with the data above.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(ggimage)
url.logo &amp;lt;- getURL(&amp;quot;https://raw.githubusercontent.com/statsbylopez/BlogPosts/master/nfl_teamlogos.csv&amp;quot;)
df.logos &amp;lt;- read.csv(text = url.logo)
scrimmage.plays.summary &amp;lt;- scrimmage.plays.summary %&amp;gt;% 
  left_join(df.logos, by = c(&amp;quot;posteam&amp;quot; = &amp;quot;team_code&amp;quot;))

ggplot(scrimmage.plays.summary, aes(run, pass)) + 
  geom_image(aes(image = url), size = 0.05) + 
  xlab(&amp;quot;Run: average offensive EPA&amp;quot;) + 
  ylab(&amp;quot;Pass: average offensive EPA&amp;quot;) + 
  theme_minimal() + 
  labs(title = &amp;quot;Offensive performance, 2018 season&amp;quot;, subtitle = &amp;quot;Data courtesy: nflscrapR&amp;quot;) + 
  geom_hline(aes(yintercept = 0), lty = 2, col = &amp;quot;red&amp;quot;, alpha = 0.5)+ 
  geom_vline(aes(xintercept = 0), lty = 2, col = &amp;quot;red&amp;quot;, alpha = 0.5) + 
  xlim(c(-0.45, 0.45)) + ylim(c(-0.45, 0.45)) + 
  geom_text(data = df.text, aes(x, y, label = lab.text), colour = &amp;quot;red&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/2018-10-25-nfl-team-logos-using-ggimage_files/figure-html/unnamed-chunk-2-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Same chart as we initially had, and one-less line of code. The key command is &lt;code&gt;geom_image&lt;/code&gt;, which functions similar to &lt;code&gt;geom_point&lt;/code&gt; but requires a url to draw an image from.&lt;/p&gt;
&lt;p&gt;Feel free to use the logo file in similar fashion – and I hope you do! Graphs with logos often look better than their text counterparts. One next step will be to jitter team-logos to prevent overlap, but that’s for another day.&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Lessons hidden in sports betting markets</title>
      <link>/post/lessons-hidden-in-sports-betting-markets/</link>
      <pubDate>Wed, 22 Aug 2018 00:00:00 +0000</pubDate>
      
      <guid>/post/lessons-hidden-in-sports-betting-markets/</guid>
      <description>&lt;p&gt;With sports betting now legal in several US states, I might as well give away my number one piece of advice for amateurs looking to gamble:&lt;/p&gt;

&lt;p&gt;Don&amp;rsquo;t bet.&lt;/p&gt;

&lt;p&gt;It&amp;rsquo;s an easy recommendation. Numbers implied by betting markets are too good, too close to the truth that, when accounting for the vig, it&amp;rsquo;s nearly impossible to make a long term profit.&lt;/p&gt;

&lt;p&gt;But just because your local statistician tells you not to bet doesn&amp;rsquo;t mean you shouldn&amp;rsquo;t check out betting market odds. In fact, it&amp;rsquo;s just the opposite. There&amp;rsquo;s no single piece of public information that is more accurate and informative with respect to a professional sports game than the closing odds.  Related: there is no better standard with which sports scientists can compare prediction models than to compare to betting odds.&lt;/p&gt;

&lt;p&gt;In a recent paper, &lt;a href=&#34;http://www.science.smith.edu/~bbaumer/w/&#34; target=&#34;_blank&#34;&gt;Ben&lt;/a&gt;, &lt;a href=&#34;https://statsinthewild.com/&#34; target=&#34;_blank&#34;&gt;Greg&lt;/a&gt;, and I took a deep dive to learn about what betting odds tell us about the four major North American pro sports leagues, the NBA, NHL, NFL, and MLB (sorry, MLS, but three-way odds are a different story). It&amp;rsquo;s titled &amp;ldquo;How often does the best team win? A unified approach to understanding randomness in North American sport,&amp;rdquo; but our alternate title might as well be &amp;ldquo;Betting markets: if you can&amp;rsquo;t beat em, use them in a statistical model.&amp;rdquo; I&amp;rsquo;d welcome readers to check out a pre-print of the &lt;a href=&#34;https://arxiv.org/abs/1701.05976&#34; target=&#34;_blank&#34;&gt;manuscipt&lt;/a&gt;, forthcoming in &lt;a href=&#34;https://www.imstat.org/journals-and-publications/annals-of-applied-statistics/&#34; target=&#34;_blank&#34;&gt;Annals of Applied Statistics&lt;/a&gt;, if they are interested in more details. As the paper&amp;rsquo;s focus more on the technical side, what&amp;rsquo;s missing is a cohesive summary of what it all means. In other words, how can we use our results &amp;ndash; built using betting market data &amp;ndash; to make better decisions in sports?&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ll provide several ideas in the following set of posts.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Part I: &lt;a href=&#34;http://statsbylopez.netlify.com/post/part-i-randomness-of-games/&#34; target=&#34;_blank&#34;&gt;Why I feel bad for Max Scherzer (on the game-level randomness in sports)&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Part II: &lt;a href=&#34;http://statsbylopez.netlify.com/post/part-ii-randomness-of-series/&#34; target=&#34;_blank&#34;&gt;Rethinking our playoff philosophy (on the role of chance in the postseason)&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Part III: &lt;a href=&#34;http://statsbylopez.netlify.com/post/playing-at-home/&#34; target=&#34;_blank&#34;&gt;Rocky Mountain High (The benefit of playing at home)&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Part IV: &lt;a href=&#34;http://statsbylopez.netlify.com/post/part-iv-schedule-strength/&#34; target=&#34;_blank&#34;&gt;Why the Orioles should have traded Manny Machado to the Dodgers for a spot in the NL West (on schedule strength)&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Hopefully you&amp;rsquo;ll be able to use these posts to learn a bit of insight into how each sports leagues compare to one another, and how various factors can play a major role in team success.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Note: this series of post is based off of a forthcoming academic paper and does not reflect views of my current employer (the NFL).&lt;/em&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Part I: Why I feel bad for Max Scherzer (on the game-level randomness in sports)</title>
      <link>/post/part-i-randomness-of-games/</link>
      <pubDate>Wed, 22 Aug 2018 00:00:00 +0000</pubDate>
      
      <guid>/post/part-i-randomness-of-games/</guid>
      <description>&lt;p&gt;The best team in baseball during the 2013 season was the Detroit Tigers.&lt;/p&gt;

&lt;p&gt;Detroit&amp;rsquo;s rotation featured the eventual Cy Young award winner (Max Scherzer), alongside both the 2011 and 2016 Cy winners (Justin Verlander and Rick Porcello, respectively). The Tigers line-up was spearheaded by Prince Fielder and Miguel Cabrera, the latter of whom would win his second consecutive MVP. Indeed, betting market rankings had the Tigers atop the sport &lt;a href=&#34;https://statsbylopez.github.io/NESSIS2017_files/NESSIS_2017.html#section-2&#34; target=&#34;_blank&#34;&gt;for basically the entire season&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;But on October 19th of that year, the best team in baseball was fighting to save its season. The Tigers trailed the Boston Red Sox three games to two in Game 6 the American League Championship series, with each of Detroit&amp;rsquo;s three losses coming by exactly one run. Needing a win to force a game 7, Scherzer gave the Tigers a bit of hope, in the form of a 2-1 lead as the teams went to the bottom of the 7th inning.&lt;/p&gt;

&lt;p&gt;It&amp;rsquo;s at that point in the game that the best team in baseball was also its unluckiest.&lt;/p&gt;

&lt;p&gt;It started with a runner on second, one out, and Xander Bogaerts at the plate. With a full count, Scherzer threw a pitch that umpires almost always call a strike 3.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/post/2018-08-22-part-i-randomness-of-regular-season-competition_files/xander.gif&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;But instead of strike 3, home plate umpire Dan Iassogna called the pitch ball 4. And so instead of a runner on 2nd and two outs, the Red Sox now had two runners on and out out. Iassogna&amp;rsquo;s decision &amp;ndash; one umpires only call a ball about 1 in 7 times &amp;ndash; dropped the Tigers&amp;rsquo; win expectency by about 12 percentage points.&lt;/p&gt;

&lt;p&gt;Next, Detroit reliever Drew Smily induced a chopper up the middle off the bat of Jacoby Ellsbury, hit in the direction of shortstop Jose Iglesias. It&amp;rsquo;s the type of play Iglesias often starts a double play on. Worst case for the Tigers, one would think, he&amp;rsquo;d record only one out.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/post/2018-08-22-part-i-randomness-of-regular-season-competition_files/jose.gif&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;But Iglesias bumbled the ball, recording no outs and leaving the bases loaded. Allowing for one out on the play, the error was worth about a 20 perentage point drop in win expectency for Detroit.&lt;/p&gt;

&lt;p&gt;Scherzer and the Tigers should&amp;rsquo;ve been out of the inning but for a few bad breaks. But they weren&amp;rsquo;t, which allowed Shane Victorino to step to the plate with the bases loaded. Victorino&amp;rsquo;s at-bat involved a little less luck; he hit a grand slam, and the Tigers season was effectively over.&lt;/p&gt;

&lt;p&gt;The Tigers&amp;rsquo; final game was heartbreaking, and indicative of one of the most humbling aspects of being a sports fan: the better team doesn&amp;rsquo;t always win, even when it may deserve to. It happened for the Tigers in 2013, but it happens for all teams in all seasons and in almost all sports. Sometimes it&amp;rsquo;s factors that are completely outside of a the better teams control &amp;ndash; a referee call, a bad bounce, poor conditions, or, like the Tigers, a missed strike three. Or sometimes the better team just plays poorly &amp;ndash; missing open three-pointers, field goals, saves, or, like the Tigers, easy ground balls up the middle. Or sometimes the &amp;ldquo;better&amp;rdquo; team might simply be so close in terms of talent to the &amp;ldquo;worse&amp;rdquo; team, that any number of plays, shots, or referee decisions could play into the game&amp;rsquo;s outcome, actions that, by and large, are noise and not indicative of any particular skill or talent. However it happens, being the better team doesn&amp;rsquo;t exactly equate to always being the team with more runs, goals, or points.&lt;/p&gt;

&lt;p&gt;When Greg, Ben and I set out to compare North American sports, our principal goal was to consider how often, in each sport, the better team ended up winning. Here&amp;rsquo;s our main take-home, which summarizes the game-level randomness of each league.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/post/2018-08-22-part-i-randomness-of-regular-season-competition_files/parity2.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;On the far left, the NHL and MLB games cluster closer to coin flips; that is, if we were to randomly take a game between two randomly drawn teams, it&amp;rsquo;s less likely that the best team will win. As referenced above, part of this is luck &amp;ndash; one can surmise that given the low amounts of scoring involved in baseball and hockey, more breaks are needed to win &amp;ndash; but a related part of it is also because the best teams in the MLB and in the NHL can still lose to the worse teams and fans wouldn&amp;rsquo;t be &lt;em&gt;that&lt;/em&gt; surprised. The gaps in talent in those leagues are, at least relatively, not as wide.&lt;/p&gt;

&lt;p&gt;Alternatively, the NFL and NBA roughly live in a world halfway between coin-flips and pre-determined outcomes.&lt;/p&gt;

&lt;p&gt;Our findings are somewhat unique. There&amp;rsquo;s a whole literature on competitive balance that&amp;rsquo;s out there, with which we are only in partial agreement. For example, though tempting, answering a question like ours &lt;a href=&#34;https://www.vox.com/videos/2017/6/5/15740632/luck-skill-sports&#34; target=&#34;_blank&#34;&gt;can&amp;rsquo;t be done using win percentages&lt;/a&gt;, because win percentages are effected by things like schedule strength and number of games.&lt;/p&gt;

&lt;p&gt;But more importantly, our findings highlight the immense power of betting market data which, when combined with a statistical modeling framework that can account for changes to team strength, allows us to capture league-level and team-level traits that have, to-date, mostly been unknown.&lt;/p&gt;

&lt;p&gt;Indeed, Scherzer&amp;rsquo;s bad break is but one anecdote behind several ways in which our work can inform decision makers and fans alike. Here&amp;rsquo;s a list of several take-homes that come with a better understanding of the randomness of sporting outcomes.&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;Luck (or just generally uncertainty) plays an enormous role in MLB and NHL outcomes. The worse team can beat the better team. Sometimes, shit just happens.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Looking at standings to determine how good each team is? Stop &amp;ndash; you can do better. Our betting market metrics of how good each team is are better predictors of future won-loss percentage than current won-loss percentage is. In other words, if you look at the standings, and I look at betting market data, I&amp;rsquo;ll have more accurate predictions of how the rest of the season will shake out than you will (and I don&amp;rsquo;t even need to know win percentages to make that claim).&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Afraid of our modeling? Use Mike Beuey&amp;rsquo;s ratings at &lt;a href=&#34;http://www.inpredictable.com/&#34; target=&#34;_blank&#34;&gt;Inpredictable&lt;/a&gt;. Bookmark his site. Market ratings like this are more on point than just about any public metric out there, and certainly better than standings or most power rankings. The data&amp;rsquo;s that good. If you want to know how good a team is, check to see when it&amp;rsquo;s a favorite or when it&amp;rsquo;s an underdog.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Here are a few specific ways that decision-makers could use betting market information.&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Is your team going to make the playoffs? Start with betting market data, estimate probabilities for each game and each team, simulate the rest of the season, and find out.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Should you trade for a certain player?  Here&amp;rsquo;s an easy, back-of-the-envelope way to estimate how valuable a player is: compare how betting odds stack up when this player is and isn&amp;rsquo;t in the lineup.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;What are your chances of winning a title if you do make the playoffs? Simulate the postseason. Don&amp;rsquo;t be surprised if your team doesn&amp;rsquo;t win, even if it&amp;rsquo;s the best team (hint: I&amp;rsquo;ll do this in my next post)&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Altogether, the traditional mechanism by which we evaluate teams — wins and losses - can belie characteristics that are vital to understanding team strength. Turns out, NHL and MLB outcomes are closer to 50-50 calls than those in the NFL and NBA, and the difference between those two pairs of leagues is fairly large.  For fans, and perhaps Max Scherzer, hopefully this provides a modicum of comfort when your favorite team falls short.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Note: This is Part I in a set of posts of how betting markets can inform sports fans. To return to the series homepage, click &lt;a href=&#34;http://statsbylopez.netlify.com/post/lessons-hidden-in-sports-betting-markets/&#34; target=&#34;_blank&#34;&gt;here&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Part II: Rethinking our playoff philosophy (on the role of chance in the postseason)</title>
      <link>/post/part-ii-randomness-of-series/</link>
      <pubDate>Wed, 22 Aug 2018 00:00:00 +0000</pubDate>
      
      <guid>/post/part-ii-randomness-of-series/</guid>
      <description>

&lt;p&gt;In the 2016-17 season, the Washington Capitals &lt;a href=&#34;https://www.washingtonpost.com/news/fancy-stats/wp/2017/02/09/this-is-the-most-dominating-washington-capitals-team-ever-so-whats-it-mean-for-the-cup/?noredirect=on&amp;amp;utm_term=.940cf4c44b8f&#34; target=&#34;_blank&#34;&gt;dominated&lt;/a&gt; the NHL like few teams in recent history, winning the Presidents&amp;rsquo; Trophy with 118 points.&lt;/p&gt;

&lt;p&gt;The Caps entered a 2nd-round playoff series with Pittsburgh as decent-sized favorites (58 percent), and sure enough, Washington outplayed its rivals. In each of seven consecutive games, the Capitals outshot the Penguins, finishing with 70 total more shots on goal.&lt;/p&gt;

&lt;p&gt;Unfortunately for Washington, not enough shots turned into goals, and because hockey games are decided by goals, it was the Penguins that moved onto the Eastern Conference Finals. The Caps were sent home, with the early exit enough to drive NBC commentator Mike Milbury to the brink.&lt;/p&gt;

&lt;p&gt;&amp;ldquo;They have to rethink their whole philosophy,&amp;rdquo; Milbury &lt;a href=&#34;https://twitter.com/StatsbyLopez/status/862503623565205504&#34; target=&#34;_blank&#34;&gt;suggested&lt;/a&gt; after the game.&lt;/p&gt;

&lt;p&gt;I probably don&amp;rsquo;t need to tell you what happened next. The Caps made a few changes to their roster &amp;ndash; call it a reconsidered philosophy &amp;ndash; enough so that by this year&amp;rsquo;s 2nd-round, they were the &lt;a href=&#34;https://twitter.com/StatsbyLopez/status/990611488401510401&#34; target=&#34;_blank&#34;&gt;least likely&lt;/a&gt; team among the eight remaining to raise a Stanley Cup. Despite those odds, Washington won its first title.&lt;/p&gt;

&lt;p&gt;&amp;ldquo;This Capitals team doesn’t have better talent than years past, but they have better focus and attitudes,&amp;rdquo; Milbury argued.&lt;/p&gt;

&lt;p&gt;Washington&amp;rsquo;s rise to the top of the NHL illustrates that, in hockey&amp;rsquo;s postseason, surprising things can happen. In the rest of this post, I opine on what should and shouldn&amp;rsquo;t be surprising in playoff competition, using the NHL, NBA, NFL, and MLB.&lt;/p&gt;

&lt;h2 id=&#34;when-does-the-better-team-win-in-the-postseason&#34;&gt;When does the better team win in the postseason?&lt;/h2&gt;

&lt;p&gt;Let&amp;rsquo;s start with some trivia.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Two NBA playoff teams from the last decade are drawn at random and play one another in a &amp;ldquo;best-of-7&amp;rdquo; series &amp;ndash; what is the probability that the better team wins out?&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Turns out, it&amp;rsquo;s about 80%. In other words, the best NBA team advances, on average, in roughly four of five series.&lt;/p&gt;

&lt;p&gt;That&amp;rsquo;s a pretty high number &amp;ndash; how does it compare to other sports?&lt;/p&gt;

&lt;p&gt;Given what we&amp;rsquo;ve learned in previous &lt;a href=&#34;http://statsbylopez.netlify.com/post/part-i-randomness-of-games/&#34; target=&#34;_blank&#34;&gt;posts&lt;/a&gt;, it&amp;rsquo;s no shock to find out that both the NHL and MLB hover just above 60% in &amp;ldquo;best-of-7&amp;rdquo; formats, which is notably lower. However, let&amp;rsquo;s switch that question just a bit:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;How long would postseason series need to be in NFL, MLB and NHL to match the NBA&amp;rsquo;s &amp;ldquo;better team advances&amp;rdquo; rate of 80%?&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Here&amp;rsquo;s what &lt;a href=&#34;https://arxiv.org/abs/1701.05976&#34; target=&#34;_blank&#34;&gt;Ben, Greg, and I found&lt;/a&gt;.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;In the NFL, a &amp;ldquo;best-of-11&amp;rdquo; series is needed to match the NBA&amp;rsquo;s better team advances rate.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;In the NHL, a &amp;ldquo;best-of-51&amp;rdquo; series is needed to match the NBA&amp;rsquo;s better team advances rate.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;And in MLB, an astounding &amp;ldquo;best-of-75&amp;rdquo; series is needed to match the NBA&amp;rsquo;s better team advances rate.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;That is, if we wanted postseason formats to be equivalent across leagues, we&amp;rsquo;d need the NHL and MLB to do complete, and obviously ludicrous, overhauls.&lt;/p&gt;

&lt;h2 id=&#34;how-can-we-compare-one-postseason-format-to-another&#34;&gt;How can we compare one postseason format to another?&lt;/h2&gt;

&lt;p&gt;The NFL&amp;rsquo;s never going to use a &amp;ldquo;best-of-7&amp;rdquo; format, nor is MLB going to use a &amp;ldquo;best-of-75&amp;rdquo; format.&lt;/p&gt;

&lt;p&gt;Instead, to better contrast each league, &lt;a href=&#34;https://arxiv.org/abs/1701.05976&#34; target=&#34;_blank&#34;&gt;Greg, Ben and I&lt;/a&gt; derived a general metric that takes existing postseason formats (number of teams, rounds, games in each round, etc), mixed in our measurements of team strength, and identified how closely each league aligned with a completely deterministic model where the best team &lt;em&gt;always&lt;/em&gt; advanced and won a title.&lt;/p&gt;

&lt;p&gt;Here&amp;rsquo;s a plot that summarizes the equivalence of current postseason formats in each of the MLB, NFL, NHL, and NBA. Tournaments where the better team always advanced would score on the far right, while tournaments where every franchise had an equal chance in each round would show up on the far left.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/post/2018-08-22-part-i-randomness-of-regular-season-competition_files/parity.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Unsurprisingly, the NBA stands out.* Better NBA teams more often advance, and the best NBA team more often wins out.&lt;/p&gt;

&lt;p&gt;Interestingly, the NHL, MLB, and NFL all somewhat overlap. In other words, each league&amp;rsquo;s postseason structure roughly does a similar job of allowing better teams to advance.&lt;/p&gt;

&lt;h2 id=&#34;so-what-s-this-all-mean&#34;&gt;So what&amp;rsquo;s this all mean?&lt;/h2&gt;

&lt;p&gt;Well, here&amp;rsquo;s where the list gets long.&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;The best team doesn&amp;rsquo;t always win in the postseason in any sport. However, the best team is substantially more likely to win in the NBA than in any of the other three leagues.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Compared to our &lt;a href=&#34;http://statsbylopez.netlify.com/post/part-i-randomness-of-games/&#34; target=&#34;_blank&#34;&gt;regular season findings&lt;/a&gt;, the NFL is less aligned with the NBA in the figure above. However, there&amp;rsquo;s an easy explanation &amp;ndash; the NFL&amp;rsquo;s single elimination playoff format. Single elimination tournaments add noise &amp;ndash; it&amp;rsquo;s why the NCAA hoops tournament is called March Madness, after all &amp;ndash; which decrease the chances that better teams advance. It&amp;rsquo;s why the NFL frequently has champs that seem to come from nowhere, including the 2001 Patriots, 2007 Giants, and 2011 Ravens. In such instances, we shouldn&amp;rsquo;t be surprised when NFL teams that seem like surprises win out. It&amp;rsquo;s what happens in single elimination formats.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Another subtle difference in the NFL: it&amp;rsquo;s the only league where a team is generally not given home advantage in the title game/series. One of the best sports teams of all time &amp;ndash; the 2007 Patriots &amp;ndash; lost to the Giants on a neutral field in a one-game Super Bowl. Imagine the 2018 Warriors playing the Cavs for an NBA title in a one-game series in, say, Indianapolis? Yes, that&amp;rsquo;d be incredible theater. But it&amp;rsquo;d be incredible theater for the same reason that March Madness games are often incredible theater. The Warriors would be favored, but the Cavs&amp;rsquo; chances in such a set-up would increase by several orders of magnitude, relative to the current NBA format.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;From a team&amp;rsquo;s standpoint, understanding the inherent randomness of postseason outcomes is critical. Some examples:&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Last seed into the NHL, NFL, or MLB playoffs? You still have a chance. And that&amp;rsquo;s worth playing hard for, because, in all likelihood, having the worst chance is still actually a reasonable chance.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Last seed in the NBA playoffs? Your work is cut out for you.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Win a title? Congrats! Now check if you are one of the best teams. If you are, even better. But if you aren&amp;rsquo;t the best team &amp;ndash; say, you are the 2013 Red Sox, which won after &lt;a href=&#34;https://statsbylopez.github.io/NESSIS2017_files/NESSIS_2017.html#how-often-does-the-best-team-win&#34; target=&#34;_blank&#34;&gt;getting every break in the book&lt;/a&gt; against a more talented Tigers team &amp;ndash; don&amp;rsquo;t simply bring back all of your players and think that lightning will strike twice. It usually doesn&amp;rsquo;t &amp;ndash; the 2014 Red Sox, with largely the same pieces as in 2013, finished in last place in the American League East.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Fail to win a title? Here&amp;rsquo;s where an understanding postseason tournament formats is most critical. If you are one of the top teams, do your best to keep going. Convince folks internally how talented and skilled your team actually was. Don&amp;rsquo;t be afraid to point out things like randomness and luck (or to show them this article). And don&amp;rsquo;t do things like &amp;ldquo;rethink your whole philosophy.&amp;rdquo; Though, in fairness, &amp;ldquo;don&amp;rsquo;t do things that Mike Milbury says to do&amp;rdquo; shouldn&amp;rsquo;t need so much math.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Consider tweaks to current playoff formats. The NBA begins its playoffs with a &amp;ldquo;best-of-7&amp;rdquo; series between No. 1 and No. 8 seeds. Sweeps in these matchups are often more likely than &lt;em&gt;any&lt;/em&gt; wins from the No. 8 seed. Meanwhile, MLB starts with a one-game play-in game and a &amp;ldquo;best-of-5&amp;rdquo; series between a No. 1 seed and roughly the equivalent of a No. 4 seed. In some years, however, MLB&amp;rsquo;s No. 4 seed may be nearly as good as its No. 1 (that may happen this year with the Yankees). Altogether, MLB and NHL postseason formats don&amp;rsquo;t do enough to reward good teams, while the NBA arguably does too much.**&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Stop the all-consuming allocation of credit and skill to teams that win titles and to teams that win titles alone. This is particularly biting in the NFL, MLB and NHL, where a fumble recovery, third strike call, or crossbar can make a difference between winning a ring and not winning one.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Conversely, labeling once-in-a-generation players as chokers isn&amp;rsquo;t quite appropriate, particularly in sports where it&amp;rsquo;s tougher to win in the postseason. See this from &lt;a href=&#34;https://www.rollingstone.com/culture/culture-lists/10-biggest-chokers-in-sports-history-108696/alexander-ovechkin-109184/&#34; target=&#34;_blank&#34;&gt;Rolling Stone&lt;/a&gt; in 2017 on Alex Ovechkin.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Beware of snake oil when it comes to postseason predictions. If it seems to good to be true, it probably is. As a hypothetical example, if a company says it can predict MLB or NHL series outcomes with 85-percent accuracy, perhaps avoid hiring that company to be the official sponsor of your league&amp;rsquo;s stats page.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;summary&#34;&gt;Summary&lt;/h2&gt;

&lt;p&gt;This post was long, but the varying formats and differing levels of league skill make postseason tournament outcomes in the MLB, NBA, NFL, and NHL complex to contrast. For team officials, coaches, players, and fans, an acknowledgement of the operating characteristics of each league can improve our overall understanding of how and when teams win in postseason play.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Footnotes&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;*We likely underestimated the deterministic nature of the NBA in our article. To derive team strengths, we used regular season data. However, stars play a more dominant role in the NBA&amp;rsquo;s postseason, which means it can be difficult to pick up on how teams like Golden State or Cleveland will improve from their regular season results.&lt;/p&gt;

&lt;p&gt;**The NFL is perfect and that is an unbiased opinion.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Note: This is Part II in a set of posts of how betting markets can inform sports fans. To return to the series homepage, click &lt;a href=&#34;http://statsbylopez.netlify.com/post/lessons-hidden-in-sports-betting-markets/&#34; target=&#34;_blank&#34;&gt;here&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Part III: Rocky Mountain High (the benefit of playing at home)</title>
      <link>/post/playing-at-home/</link>
      <pubDate>Wed, 22 Aug 2018 00:00:00 +0000</pubDate>
      
      <guid>/post/playing-at-home/</guid>
      <description>&lt;p&gt;One way in which professional sports are relatively fair is that, in each season, teams are almost always given an identical number of home games. This seems like an obvious way to run a sports organization, until you remember that postseason berths in NCAA hoops and football often hinge on incredibly unbalanced schedules.&lt;/p&gt;

&lt;p&gt;Playing at home is a benefit, and while the reasons for the overall advantage are somewhat up for &lt;a href=&#34;https://www.amazon.com/dp/B004C43GC4/ref=dp-kindle-redirect?_encoding=UTF8&amp;amp;btkr=1&#34; target=&#34;_blank&#34;&gt;debate&lt;/a&gt;, there &lt;em&gt;are&lt;/em&gt; obvious and unique advantages that make playing at home different each sport.&lt;/p&gt;

&lt;p&gt;In our cross-sport paper, Ben designed a pretty amazing chart that highlights, on a probability scale, how the home advantage compares both by sport and franchise. Bars for each term correspond to 95% credible intervals.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/img/home_benefit.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;It is substantially more beneficial to play at home in the NBA, and to a lesser extent the NFL, than it is in MLB and the NHL. This isn&amp;rsquo;t surprising, and confirms what several authors before us have found.&lt;/p&gt;

&lt;p&gt;What was most intriguing, however, is if and how teams &lt;em&gt;within&lt;/em&gt; each league varied.&lt;/p&gt;

&lt;p&gt;Take the NBA, where the difference between the best home advantage (Denver, Utah) and the worst (Brooklyn) is enormous. The estimates above average out to be roughly &lt;em&gt;2.5 extra wins per year&lt;/em&gt;, in expectation, that Denver and Utah get that Brooklyn doesn&amp;rsquo;t, just by virtue of where the teams play. Using &lt;a href=&#34;https://www.brewhoop.com/2016/8/8/12354486/value-in-the-nba-whats-the-value-of-a-win&#34; target=&#34;_blank&#34;&gt;back-of-envelope&lt;/a&gt; calculations with respect to the value of a win in the NBA, the home advantage for Denver and Utah is worth about $5 million annually. This is incredible, particularly given that the marginal value of a win for Denver and Utah (good but not great teams, traditionally) is likely higher.&lt;/p&gt;

&lt;p&gt;There were likewise modest between-team differences in the home advantage in the NHL &amp;ndash; one taken to the extreme this &lt;a href=&#34;http://statsbylopez.netlify.com/post/the-vegas-flu-looks-real/&#34; target=&#34;_blank&#34;&gt;past year by Vegas&lt;/a&gt; &amp;ndash; while within each of the NFL and MLB, team-level home advantages are mostly the same.&lt;/p&gt;

&lt;p&gt;How can this help folks on teams? Here&amp;rsquo;s a short list.&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;Be cognizant of the home advantage when allocating resources at the end of the regular season to secure additional home games in the postseason. As an example, it makes more sense to rest a star starting pitcher in MLB but lose a relatively small home advantage than it does to rest a star quarterback in the NFL and lose a relatively big home advantage.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Resist the temptation of worrying about the home-advantages in a 7-game series in MLB (and to a lesser extend the NHL). The home advantage only matters if the series goes to 7-games, and if it does go to 7-games, it&amp;rsquo;ll be, relatively speaking, a tiny benefit.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Recognize the difficulty of playing in Denver and Utah with respect to travel, rest, line-up usage, and the distribution of playing time. It&amp;rsquo;s not just the NBA &amp;ndash; both the Broncos and Rockies rate first in their leagues in terms of the benefit to playing at home.&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;Note: This is Part III in a set of posts of how betting markets can inform sports fans. To return to the series homepage, click &lt;a href=&#34;http://statsbylopez.netlify.com/post/lessons-hidden-in-sports-betting-markets/&#34; target=&#34;_blank&#34;&gt;here&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Part IV: The Orioles should have traded Manny Machado to the Dodgers for a spot in the NL West (on schedule strength)</title>
      <link>/post/part-iv-schedule-strength/</link>
      <pubDate>Wed, 22 Aug 2018 00:00:00 +0000</pubDate>
      
      <guid>/post/part-iv-schedule-strength/</guid>
      <description>

&lt;h2 id=&#34;taking-a-step-back&#34;&gt;Taking a step back&lt;/h2&gt;

&lt;p&gt;Most of sports analytics involve decisions made on the margins. We debate fourth down decisions that, across a season, add up to roughly a &lt;a href=&#34;https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3114242&#34; target=&#34;_blank&#34;&gt;a third of an expected win&lt;/a&gt;. We compare the merit of Cy Young candidates, when the relative difference of &lt;a href=&#34;https://legacy.baseballprospectus.com/sortable/index.php?cid=2508773&#34; target=&#34;_blank&#34;&gt;each candidate&amp;rsquo;s WAR&lt;/a&gt; equates to nothing more than rounding errors. We tell NHL coaches to pull their goalie a few minutes earlier, knowing that, in more seasons than not, not an extra point will be gained by going so.&lt;/p&gt;

&lt;p&gt;Thus, perhaps it&amp;rsquo;s worth taking a step back to analyze what can be a substantially more dominant but often unquantified force that impacts sporting results: who you opponents are.&lt;/p&gt;

&lt;h2 id=&#34;the-tougest-division-in-sports&#34;&gt;The tougest division in sports&lt;/h2&gt;

&lt;p&gt;What if teams played balance schedules? In other words, how would standings have looked if each team were to play the same set of teams that every other team plays?*&lt;/p&gt;

&lt;p&gt;Using our estimates of team strength (that vary by season and week) and home advantage (which vary between teams, most notably in the NHL and NBA), that&amp;rsquo;s the question I sought to answer. To do so, I compared how each team&amp;rsquo;s expected win total would have changed if they were to each play the same caliber opponent throughout a season. Note that this finding is not in our paper, but is at the heart of a talk I gave at the &lt;a href=&#34;https://statsbylopez.github.io/Toronto18/Toronto18.html&#34; target=&#34;_blank&#34;&gt;Fields Sports Analytics Conference in May.&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here&amp;rsquo;s a quick summary of the results: given their schedules, no set of teams has been more consistently and more strongly hurt than those in MLB&amp;rsquo;s American League East.&lt;/p&gt;

&lt;p&gt;Here&amp;rsquo;s a chart that shows the yearly impact (in terms of wins added or lost) for each AL East team that comes as a function of them simply playing the schedule they were assigned to play.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/img/ALEast1.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;A negative y-axis means a drop in wins. In other words, the chart shows that by playing in the AL East, the Orioles lose, on average, about three wins a year than what their talent suggests they otherwise deserve. The rest of the AL East isn&amp;rsquo;t far behind.&lt;/p&gt;

&lt;p&gt;The explanation is somewhat obvious: MLB currently requires teams to play each intra-divisional opponent 19 times. That means each of the Orioles, Blue Jays, and Rays have to face the Red Sox or Yankees, two of the league&amp;rsquo;s top teams in most years, in about 1 in 4 contests. There&amp;rsquo;s no equivalent in the other leagues, nor anything close.&lt;/p&gt;

&lt;p&gt;Such a set up hurts teams in the AL East for two reasons. First, because these AL East teams are winning less often than they otherwise should be, they are less likely to qualify for the playoffs simply by having fewer wins than teams in other divisions. Second, because the only way to earn an automatic MLB playoff spot is to win your division, these teams have an uphill battle in that sense in that they also have to overtake the Red Sox or Yankees in the standings.&lt;/p&gt;

&lt;p&gt;Quite frankly, when the Orioles went to trade Manny Machado, nothing would have been more valuable in terms of a return than a spot in a different division.&lt;/p&gt;

&lt;h2 id=&#34;the-best-fans-in-baseball-are-also-the-luckiest&#34;&gt;The best fans in baseball are also the luckiest&lt;/h2&gt;

&lt;p&gt;Whereas teams in the AL East have frequently been punished by virtue of being in a division with two typically great teams and generally no awful teams (2018 aside), the NL Central has generally been the opposite; typically no elite teams, and often a few terrible ones. Between 2006 and 2017, for example, St. Louis averaged +2.2 annual wins added due to an easy schedule. Across North American pro sports, that&amp;rsquo;s the greatest average benefit for any particular team.&lt;/p&gt;

&lt;p&gt;The 2011 campaign is a particularly poignant anecdote. That year, in the same division as the Astros (56 wins, and with a run differential of -181), the Cardinals (90 wins) made the playoffs as a wild card team by exactly one game over the Atlanta Braves (89 wins). Over in the AL, the Red Sox (also 90 wins) missed the playoffs altogether. Given the randomness of postseason baseball outcomes, making the playoffs made all the difference for that Cardinals team. With a playoff berth they likely only got due to an easy schedule, the 2011 Cardinals team went on to win the World Series.&lt;/p&gt;

&lt;p&gt;Even better for the Cardinals? The Astros, about to become a dominant team, moved to the American League one year later.&lt;/p&gt;

&lt;h2 id=&#34;summary&#34;&gt;Summary&lt;/h2&gt;

&lt;p&gt;Here&amp;rsquo;s a summary of other notable findings regarding schedule strength:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;The impact of MLBs schedule remains the biggest in pro sports even when accounting for its longer regular season (and thus a larger spread of wins from team to team). See &lt;a href=&#34;https://statsbylopez.github.io/Toronto18/Toronto18.html#section-5&#34; target=&#34;_blank&#34;&gt;this slide.&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;The NFL ranks second in terms of the relative impact of a team&amp;rsquo;s schedule on its number of wins; however, by and large, changes in schedule strength from one year to the next are mostly noise, and more sympotmatic of the relatively small number of games each team plays.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Schedule strength plays a smaller role in both the NBA and NHL. In that regard, wins (or points) at the end of the regular season make for a decent proxy for overall team skill.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;The impact of rest &amp;ndash; that is, having more rest than your opponent &amp;ndash; is also something that I looked at. The &lt;a href=&#34;https://statsbylopez.github.io/Toronto18/Toronto18.html#section-2&#34; target=&#34;_blank&#34;&gt;role of rest&lt;/a&gt; is largest in the NBA, followed, in order, by the NHL, NFL, and MLB. Recent steps taken by the NBA to both reduce the frequency of back-to-backs and the differences between teams in terms of number of back-to-backs are appreciated in this regard, and clearly supported by data.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;West coast teams, in general, are given more rest advantages than their East coast brethren. This likely has contributed to why West coast teams often show up as having the largest home advantages: what was really a rest advantage was often perceived as a home advantage.&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Altogether, the accurate nature of our team strength metrics has allowed us to consider outside-the-box comparisons like those presented above. In particular, the unbalanced schedule of MLB stands out as one league-level factor that, while potentially good for Sunday Night Baseball ratings, may unfairly penalize certain teams.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Note: This is Part IV in a set of posts of how betting markets can inform sports fans. To return to the series homepage, click &lt;a href=&#34;http://statsbylopez.netlify.com/post/lessons-hidden-in-sports-betting-markets/&#34; target=&#34;_blank&#34;&gt;here&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;*Teams cannot, of course, play themselves, and so even in the hypothetical scenario with balanced scheduled, good teams would have slightly easier schedules and bad teams would have slightly more difficult schedules.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>The within-game evolution of MLB’s strike zone</title>
      <link>/post/the-within-game-evolution-of-mlb-s-strike-zone/</link>
      <pubDate>Fri, 01 Jun 2018 00:00:00 +0000</pubDate>
      
      <guid>/post/the-within-game-evolution-of-mlb-s-strike-zone/</guid>
      <description>&lt;p&gt;Baseball games are &lt;a href=&#34;https://www.nytimes.com/2017/03/01/sports/baseball/baseballs-too-slow-heres-how-you-fix-it.html&#34;&gt;too slow&lt;/a&gt;, &lt;a href=&#34;https://slate.com/culture/2018/05/major-league-baseball-games-are-too-long-heres-how-to-make-them-longer.html&#34;&gt;too long&lt;/a&gt;, &lt;a href=&#34;https://www.sbnation.com/a/mlb-2017-season-preview/game-length&#34;&gt;so damned long&lt;/a&gt;, and, like my seven-year old daughter getting dressed in the morning, &lt;a href=&#34;https://fivethirtyeight.com/features/baseballs-biggest-games-are-taking-forever/&#34;&gt;taking forever&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Despite the headlines, there’s one aspect of the game that has actually worked to speed the game up: how umpires call balls and strikes. As one piece of evidence, Brian and I found that, in the bottom half of extra innings, &lt;a href=&#34;https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3129084&#34;&gt;calls tend to favor&lt;/a&gt; whichever team is closer to winning. By that point in the game, we argue, &lt;a href=&#34;https://fivethirtyeight.com/features/everyone-wants-to-go-home-during-extra-innings-maybe-even-the-umps/&#34;&gt;everyone wants to go home&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Although our evidence is strong that umpires react to the scoreline in extra innings, given the frequency with which these games happen, such extra bits of discretion are only likely to impact a game or two a week. Meanwhile, innings one through nine have, to the best of my knowledge, to-date gone unanalyzed with respect to a varying strike zone. But with the score-state for each game now available on &lt;a href=&#34;https://baseballsavant.mlb.com/&#34;&gt;baseballsavant&lt;/a&gt;, I figured a look at all innings would be more appropriate.&lt;/p&gt;
&lt;p&gt;First, I used the &lt;code&gt;baseballr&lt;/code&gt; package to acquire pitch-level data for all balls and strike calls between the 2008 and 2017 seasons (scraping code &lt;a href=&#34;https://github.com/statsbylopez/mlb-shirking/blob/master/Code/scraping.R&#34;&gt;here&lt;/a&gt;). For each pitch, I adjusted the corresponding vertical coordinate to standardize for each batter personal strike zone.&lt;/p&gt;
&lt;p&gt;Next, I averaged across each of the nine-innings and each three-inch window of a strike zone grid to identify the likelihood of a pitch in a given part of the zone being called a strike. Finally, as a baseline, I focused on the differences between each score state where one team is leading (by 1 to 3 runs, or by 4 runs or more), relative to the game being tied, done separately for each inning.&lt;/p&gt;
&lt;p&gt;Here’s a gif that works through how the strike zone changes by inning and score state. Shades of the graph in green correspond to more strikes, while purple reflects fewer strikes. You shouldn’t see much early. But please wait for the 9th-inning.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/img/output_inning.gif&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Late in games, beginning with the 8th-inning, there’s a marked increase in strike calls when one of the teams is leading. Differences are as large as 30 percentage points in the 9th-inning, and seem somewhat consistent between types of leads. This latter point is important – if the strike zone expands as equally with a 2-run lead as it does with a 12-run lead, we can be more confident that what’s driving the expansion isn’t the insertion of a star closer, as those players are only likely to be pitching with small leads.&lt;/p&gt;
&lt;p&gt;Why does this matter?&lt;/p&gt;
&lt;p&gt;For starters, let’s think about closers in general. MLB managers traditionally save their best relief pitcher for the 9th inning, with several of these players turning into generational stars that can occassionally get &lt;a href=&#34;https://thebiglead.com/2013/05/15/mariano-rivera-gets-quite-a-generous-strike-zone/&#34;&gt;strike-calls&lt;/a&gt; on balls crossed that cross into the batter’s box. But if part of why closers are perceived to be so valuable is that, in general, the strike zone is wider in the 9th-inning, perhaps that may say something about the fluidity of this role.&lt;/p&gt;
&lt;p&gt;Precisely answering this question is less straightforward, however, as there are several pitchers who have only performed in one type of spot (set-up or closer), but not both. This can be problematic from a causation standpoint, as perhaps there are different characteristics about pitchers who pitch the 9th-inning – ones that also lead to more strike calls – that are responsible for the increase. However, one way around this issue is to look only at pitchers who have performed in both roles.&lt;/p&gt;
&lt;p&gt;Here’s a chart comparing differences in strike rates between the 9th and 8th innings, using situations where the pitching team has a small lead (defined as between one and four runs). In the 9th-inning, this is traditionally the spot where teams use a closer. To lessen the worry about the impact of certain pitchers, I used only the 113 pitchers who threw at least 250 pitches in each inning in this specific situation (tight lead) between 2008 and 2017.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/img/output_98.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Across most fringe areas of the strike zone, there’s between a 5 and 10 percentage point increase in the likelihood of a strike when looking in 9th-inning pitches. In other words, even among the pitchers who tend to pitch the most, and even when considering only one specific type of situation (pitching with a tight lead), it’s better to be on the mound in the 9th-inning than in the 8th-inning.&lt;/p&gt;
&lt;p&gt;It’s worth noting that the above, to this point, is but an aggregated summary of strike rates based on a few game characteristics. Thus, there may be explanations besides umpire discretion that drive differences in strike zone size late in games. As one alternative possibility, … actually, I can’t think of one. But maybe you can?&lt;/p&gt;
&lt;p&gt;In any case, for now, we note that MLB umpires tend to call higher rates of strikes late in games when one team has a lead. Moreover, there’s a particular jump in the ninth-inning. These findings are potentially explained by an effort to speed up the game, and cannot be fully explained by a preference for star relief pitchers.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Rethinking draft curves</title>
      <link>/post/rethinking-draft-curve/</link>
      <pubDate>Wed, 25 Apr 2018 00:00:00 +0000</pubDate>
      
      <guid>/post/rethinking-draft-curve/</guid>
      <description>&lt;p&gt;When the Jets traded pick No. 6, No. 37, No. 49, and a 2019 pick to the Colts for pick No. 3, I broke out my trusty &lt;a href=&#34;https://statsbylopez.com/2016/06/22/the-making-and-comparison-of-draft-curves/&#34;&gt;draft curve&lt;/a&gt; to see what it said about the trade.&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&#34;header&#34;&gt;
&lt;th align=&#34;center&#34;&gt;Pick Number&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;Value&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;Team&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;center&#34;&gt;3&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;52.5&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;to the Jets&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;center&#34;&gt;6&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;50.6&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;to the Colts&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;center&#34;&gt;37&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;33.5&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;to the Colts&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;center&#34;&gt;49&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;28.3&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;to the Colts&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Even when you ignore the 2019 pick conveyed to the Colts, the Jets are enormous losers. To be more specific, the Colts aquired 112.4 points worth of draft value in exchange for 52.5 points. Or, perhaps a better way of putting this deal: had the Jets also received back the first pick in the deal, they would’ve just about broken even.&lt;/p&gt;
&lt;p&gt;These findings accord with just about every take I saw on the trade that came from analytically-minded sources. Even on Jimmy Johnson’s outdated version of the trade chart, &lt;a href=&#34;https://ftw.usatoday.com/2018/03/nfl-jets-colts-draft-trade-richard-thaler-nobel-prize&#34;&gt;Indianapolis&lt;/a&gt; comes out ahead.&lt;/p&gt;
&lt;p&gt;But still, something didn’t pass the smell test, and I figured it was worth a go at revisiting my draft curve.&lt;/p&gt;
&lt;div id=&#34;what-if-a-team-wants-a-superstar&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;What if a team wants a superstar?&lt;/h2&gt;
&lt;p&gt;One limitation of the draft curve above is that it focuses on the &lt;em&gt;average&lt;/em&gt; player performance. For the Jets, pick. No. 3 is worth an &lt;em&gt;average&lt;/em&gt; value of 52.5 points over the course of a career (for those scoring at home, this is reflects a player’s career &lt;a href=&#34;https://www.pro-football-reference.com/blog/index37a8.html&#34;&gt;Approximate Value&lt;/a&gt;). But a team may not be drafting for average player performance, and instead, may prefer a shot at a superstar. How can we tweak our draft curve to account for this team preference?&lt;/p&gt;
&lt;p&gt;Instead of focusing on a smoothed average at each line, we can instead set a cutoff for what it means to be a superstar, and adjust our valuation of each pick to estimate the likelihood of landing a player above that cutoff. There are several reasons to  do this, and I generally dislike setting arbitrary &lt;a href=&#34;http://statsbylopez.netlify.com/post/on-the-risks-of-categorizing-a-continuous-variable/&#34;&gt;cutoffs&lt;/a&gt;. However, there are two benefits of thinking this way. First, the valuations of each pick – the likelihood of landing a superstar – are easy to interpret, which may help in the communication of results. Second, only 11 players are allowed on the field at a given time, and so even if you nail a bunch of 7th round picks, you can’t play them all at once.&lt;/p&gt;
&lt;p&gt;There are several ways to identify a super-star. For ease of implementation, I identified the players in the top &lt;code&gt;21/22&lt;/code&gt; percentile, which is a very rough estimation of whether or not that player could have been identified as the best player on the field at any given time point. Using career AV as an outcome, this corresponds with players with a career AV greater than 66. Here’s a sample of players just above and just below the cutoff.&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&#34;header&#34;&gt;
&lt;th align=&#34;center&#34;&gt;Name&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;Pos&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;CarAV.projected&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;Star&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;center&#34;&gt;Reggie Nelson&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;DB&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;63&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;FALSE&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;center&#34;&gt;Thomas Jones&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;RB&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;62&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;FALSE&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;center&#34;&gt;Adrian Wilson&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;DB&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;64&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;FALSE&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;center&#34;&gt;Brian Westbrook&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;RB&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;69&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;TRUE&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;center&#34;&gt;Lawrence Timmons&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;LB&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;72&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;TRUE&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;center&#34;&gt;Tra Thomas&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;T&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;69&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;TRUE&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Among the players meeting our star criterion listed above, Westbrook, Timmons, and Thomas all made the Pro Bowl at least once in their careers, and each player was also named to at least one all-Pro team, so this seems like a reasonable cutoff to make.&lt;/p&gt;
&lt;p&gt;Here’s a side-by-side comparison of the two competing charts. On the left is my original draft curve, and on the right is the superstar-specific one.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/post/2018-04-25-building-a-better-draft-curve_files/figure-html/unnamed-chunk-4-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;There are notable differences between the two curves. Primarily, the &lt;code&gt;superstar&lt;/code&gt; curve on the right features a much steeper cutoff than the &lt;code&gt;average&lt;/code&gt; curve. The &lt;code&gt;superstar&lt;/code&gt; curve also makes it quite clear that by pick 100, it is exceedingly unlikely to land a superstar player.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;revising-the-jets-trade&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Revising the Jets trade&lt;/h2&gt;
&lt;p&gt;Here’s a look at the Jets/Colts trade using the superstar-based curve.&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&#34;header&#34;&gt;
&lt;th align=&#34;center&#34;&gt;Pick Number&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;Value&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;Team&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;center&#34;&gt;3&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;0.32&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;to the Jets&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;center&#34;&gt;6&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;0.29&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;to the Colts&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;center&#34;&gt;37&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;0.09&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;to the Colts&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;center&#34;&gt;49&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;0.07&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;to the Colts&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Although it’s not exactly quite right to simply add these percentages, the Jets’ return of pick No. 3 (32% chance of a star) looks a bit more reasonable. Using the star rates as pick values, the Jets gained 32 points worth of value in exchange for 43 points. That’s the equivalent of losing out on about the 27th pick in the draft (which is much more reasonable than losing out on the 1st pick in the draft).&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;building-the-best-curve&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Building the best curve&lt;/h2&gt;
&lt;p&gt;Perhaps a better draft curve incorporates both overall average pick performance &lt;em&gt;and&lt;/em&gt; star likelihood. To do that, I scaled the curves above so that they each had the same total draft valuation, took an average, and then re-scaled that average so that the first pick was worth a value of 1.&lt;/p&gt;
&lt;p&gt;Here’s that curve. The curve in the middle (shown in purple) reflects the average between the &lt;code&gt;average&lt;/code&gt; and &lt;code&gt;superstar&lt;/code&gt; curves.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/post/2018-04-25-building-a-better-draft-curve_files/figure-html/unnamed-chunk-6-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Using the so-called &lt;code&gt;blended&lt;/code&gt; draft curve, here’s a final look at the Jets/Colts trade.&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&#34;header&#34;&gt;
&lt;th align=&#34;center&#34;&gt;Pick Number&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;Value&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;Team&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;center&#34;&gt;3&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;27.8&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;to the Jets&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;center&#34;&gt;6&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;25.4&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;to the Colts&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;center&#34;&gt;37&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;10.8&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;to the Colts&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;center&#34;&gt;49&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;8.7&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;to the Colts&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;The Colts still made out like bandits – roughly getting about a 60% rate or return on their No. 3 pick – but it doesn’t look as egregious as it initially did. Roughly, the Colts got value worth about the 20th pick in the draft for free by this blended approach.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;final-thoughts&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Final thoughts&lt;/h2&gt;
&lt;p&gt;A blended draft curve is by no means final, but it’s one approach for considering how teams aren’t just drafting for average value, and that they are often looking for a superstar. I should also note that this isn’t my idea at all – Michael Schuckers wrote about it in JQAS, a paper you can read &lt;a href=&#34;http://statsportsconsulting.com/main/wp-content/uploads/Schuckers_JQAS_NFL_Draft.pdf&#34;&gt;here&lt;/a&gt;. Schuckers uses a blend of outcomes to make a final draft curve, and there’s no reason to suspect that mine is any better than his.&lt;/p&gt;
&lt;p&gt;Teams &lt;em&gt;should&lt;/em&gt; be doing deeper research into making similar curves for themselves. These &lt;em&gt;should&lt;/em&gt; include the salary for each pick, our could use better cutoffs to reflect what they are looking for in players (superstar, consistent starter, etc). But for now, hopefully it makes a bit of sense why an initial, smoothed draft curve may be limited.&lt;/p&gt;
&lt;p&gt;If you want to evaluate trades yourself using the blended curve, I uploaded a table &lt;a href=&#34;https://docs.google.com/spreadsheets/d/15_doA989vn-JoWYqktRU3yLH7ciHB4Jd8RS1m2erGZo/edit?usp=sharing&#34;&gt;here&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>The Vegas flu looks real — but somehow the Chicago Blackhawks also got sick</title>
      <link>/post/the-vegas-flu-looks-real/</link>
      <pubDate>Wed, 11 Apr 2018 00:00:00 +0000</pubDate>
      
      <guid>/post/the-vegas-flu-looks-real/</guid>
      <description>&lt;p&gt;In yesterday’s post, I walked through the use of a &lt;a href=&#34;http://statsbylopez.netlify.com/post/a-state-space-model-to-evaluate-sports-teams/&#34;&gt;state-space&lt;/a&gt; model to evaluate NHL team strength over the course of an NHL season.&lt;/p&gt;
&lt;p&gt;But analyzing team strength is just the start of how we can use this type of framework to analyze betting market data in sports. In today’s post, I’ll ask a different question – What team had the best home advantage? And did perceptions of any teams (cough cough, Vegas) change over the course of the season?&lt;/p&gt;
&lt;div id=&#34;the-vegas-flu&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;The Vegas Flu&lt;/h2&gt;
&lt;p&gt;Around mid-December – according to a Google search, &lt;a href=&#34;http://www.espn.com/nhl/story/_/id/21825994/nhl-vegas-flu-real-golden-knights-stunning-home-success&#34;&gt;December 20th&lt;/a&gt; – the public became aware of the Golden Knights’ incredible start at home. Vegas started the season 14-2-1 at T-Mobile Arena, shocking pre-season &lt;a href=&#34;http://www.espn.com/nhl/story/_/id/20841111/2017-18-nhl-season-preview-vegas-golden-knights&#34;&gt;predictions&lt;/a&gt; that had the Golden Knights as one of the worst teams in hockey.&lt;/p&gt;
&lt;p&gt;Yesterday’s post used a time-varying model of team strength that, while able to pick up on changes in team strength with Vegas, also assumed that (i) each NHL team had the same home advantage and (ii) there was no impact of team rest on market numbers. However, both of these assumptions are testable with by adding a few more variables to our model.&lt;/p&gt;
&lt;p&gt;Here was our initial model:
&lt;span class=&#34;math display&#34;&gt;\[
\text{E}[\text{logit}(p_{i,j,w})] = \theta_{i,w} - \theta_{j,w} + \alpha,
\]&lt;/span&gt;
We expand that model to
&lt;span class=&#34;math display&#34;&gt;\[
\text{E}[\text{logit}(p_{i,j,w})] = \theta_{i,w} - \theta_{j,w} + \alpha_i,
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;which allows for each team &lt;span class=&#34;math inline&#34;&gt;\(i\)&lt;/span&gt; to have its own intercept. But we’re not done yet. The final model,&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[
\text{E}[\text{logit}(p_{i,j,w})] = \theta_{i,w} - \theta_{j,w} + \alpha_i + \beta_1*Rest_i + \beta_2*Rest_j,
\]&lt;/span&gt;
includes binary indicators &lt;span class=&#34;math inline&#34;&gt;\(Rest_i\)&lt;/span&gt; and &lt;span class=&#34;math inline&#34;&gt;\(Rest_j\)&lt;/span&gt; which indicate whether or not the home (&lt;span class=&#34;math inline&#34;&gt;\(i\)&lt;/span&gt;) or away (&lt;span class=&#34;math inline&#34;&gt;\(j\)&lt;/span&gt;) team was better rested prior to the game. Note that for rest variables, if both teams had the same rest, or both teams had at least one day of rest, these indicators were set to 0. Rest variables are important, as we hope to be able to tease out the benefit of playing at home from the benefit of playing a non-rested opponent at home.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;are-home-advantages-different&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Are home advantages different?&lt;/h2&gt;
&lt;p&gt;Yes, it appears they are.&lt;/p&gt;
&lt;p&gt;Here’s a plot of the posterior distribution of &lt;span class=&#34;math inline&#34;&gt;\(\alpha_i\)&lt;/span&gt; for each team &lt;span class=&#34;math inline&#34;&gt;\(i\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/img/vegas1.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Each teams’ curve corresponds to their estimated prediction of beating an equal-caliber opponent at home. League-wide, the average is about 55%, but some teams lie above and below that average.&lt;/p&gt;
&lt;p&gt;Overall, betting markets linked Vegas with the best home advantage during the 2017/18 season, as judged by the posterior distribution of the Golden Knights’ &lt;span class=&#34;math inline&#34;&gt;\(\alpha\)&lt;/span&gt;. However, we can be more precise: there’s about a 90% chance (using the overlap in the density curves) that Vegas was given a better home adjustment than the second best team (LA Kings). Altogether, the gaps between teams with the best and worst home advantages appear unlikely to be due to chance, which matches our findings in our original paper (&lt;a href=&#34;https://arxiv.org/abs/1701.05976&#34;&gt;link&lt;/a&gt;).&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;did-home-advantages-change&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Did home advantages change?&lt;/h2&gt;
&lt;p&gt;I replicated the same model fit above using both games before and after December 20th. Why that date? First, it’s the date of the ESPN article that publicized the idea of the Vegas Flu. Second, it’s close enough to the halfway mark of the season that it’s likely we have enough home games to judge each team with.&lt;/p&gt;
&lt;p&gt;Here’s the Golden Knights’ home advantage, both before (dark curve) and after (light curve) December 20th.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/img/vegas2.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Altogether, it looked like the Knights’ expected win percentage at home was given about a 1.75 percentage point bump after December 20th. This appears significant – but there’s also enough overlap in the two density curves that the increase could be due to chance. From a practical standpoint, this increase would plausibly effect the outcome of no more a game or two – but from a betting market standpoint, an increase of 1.75 percentage points is notable.&lt;/p&gt;
&lt;p&gt;Of course, it’d be more precise to consider the Golden Knights’ increase in light of changes to the home advantage intercepts among other teams.&lt;/p&gt;
&lt;p&gt;Here’s a plot with &lt;em&gt;every&lt;/em&gt; teams’ density curves, showing the home advantage both before (in dark) and after (in color) December 20th. Curves shaded in red reflect teams where the home advantage decreased – teams in blue correspond with an increase. I also organized teams in a weird order – from those with the biggest drop (Chicago) to the biggest increase (Vegas).&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/img/vegas3.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;I feel a bit like Jack Buck here: I can’t believe what I just saw.&lt;/p&gt;
&lt;p&gt;The team with the biggest change in home advantage is not Vegas but Chicago, which observes an estimated win percentage drop by nearly 2 percentage points. Edmonton and Montreal, the two franchises that, combined with the Blackhawks, had the three most disappointmenting seasons in the NHL, also observe drops in perceived home advantage.&lt;/p&gt;
&lt;p&gt;What does this suggest?&lt;/p&gt;
&lt;p&gt;There are likely two possibilities.&lt;/p&gt;
&lt;p&gt;First, market-perceived home advantage correlates to team strength. If the Blackhawks or Oilers stink, it is reasonable to think that playing in Chicago or Edmonton is less of worry for opponents. Fewer fans are showing up, referees are less likely to give the home team a call, and the home team is, even after accounting for team strength, a hair less likely to win.&lt;/p&gt;
&lt;p&gt;Second, which is an important caveat, our model can’t pick up when teams play different players (e.g. backup goalies). In other words, if opponents started the year playing their backups in Chicago, but ended the year playing their starters at Chicago, we’d likely be calling what was really a change in opponent behavior a change in home advantage. Alternatively, if the Blackhawks started the year playing Corey Crawford in net for all of their home games but ended the year playing, for sake of argument, a beer-league goalie off of the street, our model would not pick up on that.&lt;/p&gt;
&lt;p&gt;Either way, hopefully this post highlights some of the potential that can be found when analyzing market numbers. We can be sure that the market values each teams’ home advantage different, and that by years’ end, Vegas was given the biggest adjustment when playing at home. It’s also possible that how the market views each teams home advantage is tied to how good that team is at a particular time point.&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>A state-space model to evaluate sports teams</title>
      <link>/post/a-state-space-model-to-evaluate-sports-teams/</link>
      <pubDate>Mon, 09 Apr 2018 00:00:00 +0000</pubDate>
      
      <guid>/post/a-state-space-model-to-evaluate-sports-teams/</guid>
      <description>&lt;p&gt;A few years ago at a statistics conference, &lt;a href=&#34;https://www.luc.edu/math/ftfaculty/matthewsgregory.shtml&#34;&gt;Greg&lt;/a&gt;, &lt;a href=&#34;http://www.science.smith.edu/~bbaumer/w/&#34;&gt;Ben&lt;/a&gt; and I sat down to air a few greviences about our favorite sports. They were upset about baseball, and I was irked about hockey. Why the irritation?&lt;/p&gt;
&lt;p&gt;Relative to other popular sports like basketball and football, it seemed to us at the time that the best team was winning less often in baseball and hockey. And as fans wanting skilled teams to be rewarded, it was frustrating to so often have well-constructed teams fall short of titles.&lt;/p&gt;
&lt;p&gt;And so we decided to write a paper (pre-print &lt;a href=&#34;https://arxiv.org/abs/1701.05976&#34;&gt;here&lt;/a&gt;), now forthcoming in &lt;em&gt;Annals of Applied Statistics&lt;/em&gt;, that extends Glickman and Stern’s &lt;a href=&#34;https://homepages.cae.wisc.edu/~dwilson/rsfc/rate/papers/a-state-space-model.pdf&#34;&gt;state-space model&lt;/a&gt; to make comparisons between the NFL, NHL, NBA and MLB. In this post, I’ll describe the attraction of a state-space model, how to build one yourself (using the 2017-18 NHL season), and use our model estimates to answer a few hockey-specific questions. The entire analysis is reproducible, and you should be able to copy-and-paste your way into replicating the findings below.&lt;/p&gt;
&lt;div id=&#34;the-role-of-betting-market-data&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;The role of betting market data&lt;/h2&gt;
&lt;p&gt;Team quality in sports is not static. Players get hurt, traded, or decide to retire. Managers are fired. Teams rest players, switch starting goalies, rotate a pitching staff, or decide they want to tank. All of these aspects make measuring team strength a bit dicey.&lt;/p&gt;
&lt;p&gt;Moreso than wins and losses or point differential, perhaps the best game-level metric of team strength comes not in what happens during the game, but what’s known before the game begins. Indeed, it’s been shown &lt;a href=&#34;https://www.jstor.org/stable/2287640&#34;&gt;time&lt;/a&gt; and &lt;a href=&#34;https://statsbylopez.files.wordpress.com/2013/08/jqas-2014-0058.pdf&#34;&gt;again&lt;/a&gt; that there’s no better way to judge models in sports than to compare to betting market data. Prior to each contest, betting markets put out probabilities associated with each team winning. The reason this data is so accurate is that it takes into account all of the factors above – injuries, opponent strength, line-ups, tanking, etc. And so as the saying goes – ``if you can’t beat em, use their data to develop a state-space model.’’ Or something like that.&lt;/p&gt;
&lt;p&gt;Assume home team &lt;span class=&#34;math inline&#34;&gt;\(i\)&lt;/span&gt; (listed at -130 on the money line) is playing away team &lt;span class=&#34;math inline&#34;&gt;\(j\)&lt;/span&gt; (+110). Punters backing &lt;span class=&#34;math inline&#34;&gt;\(i\)&lt;/span&gt; believe that squad has better than a &lt;span class=&#34;math inline&#34;&gt;\(\frac{130}{230} = 56.5\%\)&lt;/span&gt; chance of winning, while betters on team &lt;span class=&#34;math inline&#34;&gt;\(j\)&lt;/span&gt; assume it has at least a &lt;span class=&#34;math inline&#34;&gt;\(\frac{100}{210} = 47.6\%\)&lt;/span&gt; probability of winning. Accounting for the vig – which markets use to ensure a long-term profit – team &lt;span class=&#34;math inline&#34;&gt;\(i\)&lt;/span&gt; can be assumed to have a &lt;span class=&#34;math inline&#34;&gt;\(54.3\%\)&lt;/span&gt; chance of beating &lt;span class=&#34;math inline&#34;&gt;\(j\)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Let’s take a look at what this data could look like. Here’s a sample of the 2017-18 NHL season (thanks to &lt;a href=&#34;https://twitter.com/pucktails&#34;&gt;Andy&lt;/a&gt; for sharing his spreadsheet, which loads using the &lt;code&gt;gsheet&lt;/code&gt; package).&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(tidyverse) 
library(rjags)
library(gsheet)
library(lubridate)
library(stringr)
library(knitr)

logit &amp;lt;- function(p) { 
  out &amp;lt;- log(p/(1 - p))
  return(out)
}

## Read in data from google sheets
urlA &amp;lt;- &amp;quot;https://docs.google.com/spreadsheets/d/1Hsmqphn9kGqWa88aYnimQxOvdV7ulv_jeIj0SYeBr3s/edit?usp=sharing&amp;quot;
nhl1718 &amp;lt;- gsheet2tbl(urlA)

## Improve the date format
nhl1718 &amp;lt;- nhl1718 %&amp;gt;% separate(date, c(&amp;quot;day&amp;quot;, &amp;quot;month&amp;quot;), &amp;quot;-&amp;quot;) %&amp;gt;% 
  mutate(date = ymd(paste(year, month, day)))

min.day &amp;lt;- min(nhl1718$date)
nhl1718 &amp;lt;- nhl1718 %&amp;gt;%
  mutate(day = date - min.day, week = as.numeric(floor(day/7) + 1))

tab.out &amp;lt;- head(nhl1718, 4) %&amp;gt;% select(date, home, away, p_home)
kable(tab.out)&lt;/code&gt;&lt;/pre&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&#34;header&#34;&gt;
&lt;th align=&#34;left&#34;&gt;date&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;home&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;away&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;p_home&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;2017-10-04&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Winnipeg Jets&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Toronto Maple Leafs&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.5284&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;2017-10-04&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Pittsburgh Penguins&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;St. Louis Blues&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.6275&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;2017-10-04&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Edmonton Oilers&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Calgary Flames&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.5900&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;2017-10-04&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;San Jose Sharks&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Philadelphia Flyers&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.5810&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;In the first four games of the year, Winnipeg, Pittsburgh, Edmonton, and San Jose were all favorites to some degree, with Pittsburgh the most plausible winner.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;building-a-state-space-model&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Building a state-space model&lt;/h2&gt;
&lt;p&gt;Let &lt;span class=&#34;math inline&#34;&gt;\(y_{i,j,w} = \text{logit}(p_{i,j,w})\)&lt;/span&gt; (in our data, this is called &lt;code&gt;p_home&lt;/code&gt;) be the log-odds of the observed betting market probability in a game played between &lt;span class=&#34;math inline&#34;&gt;\(i\)&lt;/span&gt; and &lt;span class=&#34;math inline&#34;&gt;\(j\)&lt;/span&gt; during week &lt;span class=&#34;math inline&#34;&gt;\(w\)&lt;/span&gt;. We take the &lt;code&gt;logit&lt;/code&gt; transform of each probability, which more closely aligns our outcomes with a normal distribution.&lt;/p&gt;
&lt;p&gt;We formally assume that:&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[
\text{E}[\text{logit}(p_{i,j,w})] = \theta_{i,w} - \theta_{j,w} + \alpha,
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;where &lt;span class=&#34;math inline&#34;&gt;\(\theta_{i,w}\)&lt;/span&gt; and &lt;span class=&#34;math inline&#34;&gt;\(\theta_{j,w}\)&lt;/span&gt; reflect the corresponding team strengths of &lt;span class=&#34;math inline&#34;&gt;\(i\)&lt;/span&gt; and &lt;span class=&#34;math inline&#34;&gt;\(j\)&lt;/span&gt; during week &lt;span class=&#34;math inline&#34;&gt;\(w\)&lt;/span&gt;, and &lt;span class=&#34;math inline&#34;&gt;\(\alpha\)&lt;/span&gt; is the home advantage parameter. You’ll note that as &lt;span class=&#34;math inline&#34;&gt;\(\theta_{i,w}\)&lt;/span&gt; goes up, so to does team &lt;span class=&#34;math inline&#34;&gt;\(i\)&lt;/span&gt;’s probability of winning; followers of paired comparison comparison models will recognize this formulation as identical to Bradley-Terry.&lt;/p&gt;
&lt;p&gt;A state-space model assumes that the team strength estimates (&lt;span class=&#34;math inline&#34;&gt;\(\theta_{i,w}\)&lt;/span&gt;, &lt;span class=&#34;math inline&#34;&gt;\(\theta_{j,w}\)&lt;/span&gt;, etc.) evolve over time, with team &lt;span class=&#34;math inline&#34;&gt;\(i\)&lt;/span&gt;’s strength at week &lt;span class=&#34;math inline&#34;&gt;\(w\)&lt;/span&gt; a function of both how good it was last week (&lt;span class=&#34;math inline&#34;&gt;\(\theta_{i,(w-1)}\)&lt;/span&gt;), as well as some prior noise. This is perfect for sports data – teams generally evolve slowly, and the best predictor of how good any given team is at a given time point is likely closely related to how good it was at the time just prior.&lt;/p&gt;
&lt;p&gt;Formally, we assume that for any given team &lt;span class=&#34;math inline&#34;&gt;\(i\)&lt;/span&gt;,&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[
\theta_{i,w} \sim N(\gamma\theta_{i,(w-1)},\tau_w^2),
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;which imposes a first-order auto-regressive process to team strength (denoted by &lt;span class=&#34;math inline&#34;&gt;\(\gamma\)&lt;/span&gt;). Above, &lt;span class=&#34;math inline&#34;&gt;\(\tau_w^2\)&lt;/span&gt; corresponds to week-level uncertainty in the evolution of team strength. In the long run, we assume &lt;span class=&#34;math inline&#34;&gt;\(\gamma &amp;lt; 1\)&lt;/span&gt;, which prevents team strengths from exploding, and corresponds to the fact that, eventually, the best and worst teams in pro-sports will revert towards the league average.&lt;/p&gt;
&lt;p&gt;Here’s how we can built the model above, where we use the &lt;code&gt;rjags&lt;/code&gt; package in R to do some Bayesian inference using Gibbs sampling. First, we define our model inputs using outcome &lt;span class=&#34;math inline&#34;&gt;\(y\)&lt;/span&gt;, week &lt;span class=&#34;math inline&#34;&gt;\(w\)&lt;/span&gt;, and design matrix &lt;span class=&#34;math inline&#34;&gt;\(x\)&lt;/span&gt;. For an &lt;span class=&#34;math inline&#34;&gt;\(n\)&lt;/span&gt;-game season played between &lt;span class=&#34;math inline&#34;&gt;\(T\)&lt;/span&gt;-number of teams, &lt;span class=&#34;math inline&#34;&gt;\(x\)&lt;/span&gt; corresponds to an &lt;span class=&#34;math inline&#34;&gt;\(n\)&lt;/span&gt; x &lt;span class=&#34;math inline&#34;&gt;\(T\)&lt;/span&gt; matrix, where each row contains exactly one 1 (for the home team) and one -1 (for the away team).&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;y &amp;lt;- logit(nhl1718$p_home)
w &amp;lt;- nhl1718$week

#create a design matrix 
Teams &amp;lt;- sort(as.character(unique(c(as.character(nhl1718$home)))))

#Defining the number of things
nTeams &amp;lt;- length(Teams)
nWeeks &amp;lt;- max(nhl1718$week)
n &amp;lt;- nrow(nhl1718)

#Defining the design matrix
x &amp;lt;- matrix(0, nrow = dim(nhl1718)[1], ncol = length(Teams))
for (i in 1:dim(nhl1718)[1]) {
  x[i, which(as.character(nhl1718[i,&amp;quot;home&amp;quot;]) == Teams)] &amp;lt;- (1)
  x[i, which(as.character(nhl1718[i,&amp;quot;away&amp;quot;]) == Teams)] &amp;lt;- (-1)
} &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As an example, row 1, a game between home team Winnipeg (the 31st NHL team, alphabetically) and away team Toronto (27th), has a &lt;code&gt;1&lt;/code&gt; in the 31st column and a &lt;code&gt;-1&lt;/code&gt; in the 27th column, with the rest of the entries equal to zero.&lt;/p&gt;
&lt;p&gt;Next, our Bayesian approach requires prior distributions on the parameters of interest. I’m happy to answer specific questions if you’d like, but the BUGS code below corresponds to the models above, along with some additional variance parameters that use vague priors. The &lt;code&gt;rjags&lt;/code&gt; package is a bit outdated, but here’s &lt;a href=&#34;http://www.jkarreth.net/files/bayes-cph_Tutorial-JAGS.pdf&#34;&gt;one resource&lt;/a&gt; where you can learn more.&lt;/p&gt;
&lt;p&gt;Here’s what the BUGS code looks like:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;model.string &amp;lt;-&amp;quot;
  model { 
for (i in 1:n) {
  y[i] ~ dnorm(mu[i], tauGame)
  mu[i] &amp;lt;- alpha + inprod(theta[w[i],],x[i,])
}
for (j in 1:nTeams){
  theta[1,j] ~ dnorm(0, tauSeason)
}
for (www in 2:nWeeks) {  
  for (j in 1:nTeams) {
    theta[www,j] ~ dnorm(gammaWeek*theta[www-1,j], tauWeek)
  }
}
alpha ~ dnorm(0,0.0001)
tauGame ~ dunif(0,1000) #uncertainty in outcome for each game
tauWeek ~ dunif(0,1000) 
tauSeason ~ dunif(0,1000) #variance parameter for the first week of the season
gammaWeek ~ dunif(0,1.5)
}
&amp;quot;
model.spec&amp;lt;-textConnection(model.string)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now we’re ready to fit the model. In this example, I used 3 chains, 1000 posterior draws, and a thin of 5, which yields 3 sets of 200 draws for each parameter. The model converges quickly, otherwise we’d want to increase the number of draws at each step.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(rjags)
n.chains &amp;lt;- 3 
n.adapt &amp;lt;- n.update &amp;lt;- n.draws &amp;lt;- 1000

posteriorDraws = c(&amp;#39;alpha&amp;#39;,&amp;#39;theta&amp;#39;)
thin &amp;lt;- 5
jags &amp;lt;- jags.model(model.spec,
                   data = list(&amp;#39;y&amp;#39; = y,&amp;#39;x&amp;#39; = x, &amp;#39;w&amp;#39; = w, &amp;#39;n&amp;#39; = n,&amp;#39;nTeams&amp;#39; = nTeams,&amp;#39;nWeeks&amp;#39; = nWeeks), 
                   n.chains = n.chains, n.adapt = n.adapt)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Compiling model graph
##    Resolving undeclared variables
##    Allocating nodes
## Graph information:
##    Observed stochastic nodes: 1271
##    Unobserved stochastic nodes: 842
##    Total graph size: 47475
## 
## Initializing model&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;update(jags, n.update)
z &amp;lt;- jags.samples(jags, posteriorDraws, n.draws, thin = thin)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;examining-model-output&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Examining model output&lt;/h2&gt;
&lt;p&gt;Our output file &lt;code&gt;z&lt;/code&gt; contains information related to each of the parameters we were interested in. In this case, we have &lt;code&gt;z$alpha&lt;/code&gt; (home advantage) and &lt;code&gt;z$theta&lt;/code&gt; (team strengths), which have dimensions shown below.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;dim(z$alpha)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##           iteration     chain 
##         1       200         3&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;dim(z$theta)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##                     iteration     chain 
##        27        31       200         3&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It’s generally a good idea to start a Bayesian analysis by assessing convergence – we do this extensively in our &lt;a href=&#34;https://arxiv.org/abs/1701.05976&#34;&gt;paper&lt;/a&gt; – but here’s one trace plot of &lt;code&gt;alpha&lt;/code&gt;, which shows that it’s generally well-behaved. Note the y-axis scale – given that our model uses log-odds as an outcome, each of our coefficients are likewise on a log-odds scale. Each color reflects one of the three chains from our Gibbs sampler.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;colours &amp;lt;- c(&amp;quot;#7fc97f&amp;quot;, &amp;quot;#beaed4&amp;quot;, &amp;quot;#fdc086&amp;quot;)
hfas &amp;lt;- data.frame(round(z$alpha[,,], 3))  %&amp;gt;% mutate(draw = 1:n())
hfas %&amp;gt;% ggplot(aes(draw, X1)) +
  geom_line(colour = colours[1]) + 
  geom_line(data = hfas, aes(draw, X2), colour = colours[2]) + 
  geom_line(data = hfas, aes(draw, X3), colour = colours[3]) + 
  xlab(&amp;quot;Draw&amp;quot;) + 
  ggtitle(&amp;quot;Home advantage (logit scale)&amp;quot;) + 
  ylab(&amp;quot;&amp;quot;) + 
  theme_bw()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/2018-04-09-a-state-space-model-to-evaluate-sports-team-performance_files/figure-html/unnamed-chunk-6-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The posterior distrbution of &lt;span class=&#34;math inline&#34;&gt;\(\alpha\)&lt;/span&gt; is centered at about 0.208. This suggests that home teams, when playing a similarly talented opponent, have about a &lt;span class=&#34;math inline&#34;&gt;\(\frac{e^{0.208.}}{1 + e^{0.208}} = 55\%\)&lt;/span&gt; chance of winning. For those scoring at home, the NHL has the third best home advantage among the four sports we analyzed.&lt;/p&gt;
&lt;p&gt;Next, we examine team strengths.&lt;/p&gt;
&lt;p&gt;In the code below, I averaged each team strength over each week of the NHL season, and highlight the Vegas Golden Knights, a team that rose from the bottom of the league towards the top.&lt;/p&gt;
&lt;p&gt;As with the home advantage parameter, the y-axis reflects a log-odds scale. In this case, a coefficient of 0.5 reflects that a team has an &lt;span class=&#34;math inline&#34;&gt;\(\frac{e^{0.5}}{1+e^{0.5}} = 62\%\)&lt;/span&gt; chance of beating a league average team at a neutral site.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;avgs &amp;lt;- apply(z$theta, c(1,2), mean)
dims &amp;lt;- dim(avgs)
names(dims) &amp;lt;- c(&amp;quot;nweeks&amp;quot;, &amp;quot;nteams&amp;quot;)
df.beta &amp;lt;- data.frame(
    theta = as.vector(avgs),
    week = rep(1:dims[&amp;quot;nweeks&amp;quot;]), 
    team_id = rep(Teams, each =dims[&amp;quot;nweeks&amp;quot;]) )
vegas &amp;lt;- filter(df.beta, team_id == &amp;quot;Vegas Golden Knights&amp;quot;)

ggplot(df.beta, aes(week, theta, group = team_id)) + 
  geom_point(colour = &amp;quot;grey&amp;quot;) + 
  geom_line(colour = &amp;quot;grey&amp;quot;) + 
  geom_line(data = vegas, colour = &amp;quot;#b4975a&amp;quot;) + 
  geom_point(data = vegas, colour = &amp;quot;#b4975a&amp;quot;) + 
  ggtitle(&amp;quot;NHL team strengths by week of season, 2017-18&amp;quot;) + 
  ylab(&amp;quot;theta (log-odds scale)&amp;quot;) + 
  ylim(c(-0.56, 0.56)) + 
  annotate(&amp;quot;text&amp;quot;,x = 5, y = -0.4, label = &amp;quot;Vegas&amp;quot;, colour = &amp;quot;gold4&amp;quot;, size = 5) + 
  xlab(&amp;quot;Week&amp;quot;) + theme_bw(14)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/2018-04-09-a-state-space-model-to-evaluate-sports-team-performance_files/figure-html/unnamed-chunk-7-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Vegas had a pretty incredible season.&lt;/p&gt;
&lt;p&gt;Of course, it’d be nice to see every team. Next, we use the &lt;code&gt;teamcolors&lt;/code&gt; package &lt;a href=&#34;https://github.com/beanumber/teamcolors&#34;&gt;(link)&lt;/a&gt; and a bit of &lt;code&gt;ggplot2&lt;/code&gt; wizardry to facet each NHL division in order to observe each team.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(teamcolors)
teamcolors1 &amp;lt;- teamcolors %&amp;gt;% filter(league == &amp;quot;nhl&amp;quot;) %&amp;gt;% rename(team_id = name) %&amp;gt;% 
  mutate(rand.color = ifelse(primary == &amp;quot;#010101&amp;quot;, secondary, primary))

df.beta1 &amp;lt;- df.beta %&amp;gt;% left_join(teamcolors1, by = c(&amp;quot;team_id&amp;quot; = &amp;quot;team_id&amp;quot;))

df.overall &amp;lt;- ggplot(data = df.beta1, 
       aes(x = week, y = theta, 
           color = team_id, fill = team_id)) +
  geom_line(alpha = 0.5) + 
  geom_point(shape = 21) + 
  ylim(c(-0.56, 0.56)) + 
  scale_color_manual(name = NULL, values = teamcolors1$primary) + 
  scale_fill_manual(name = NULL, values = teamcolors1$secondary) + 
  guides(color = FALSE, fill = FALSE) +
  theme_bw(base_size = 14)

df.overall + 
  geom_line(data = select(df.beta1, -division), color = &amp;quot;darkgray&amp;quot;, alpha = 0.3) + 
  geom_line(alpha = 0.5) + 
  geom_point(shape = 21, size = 0.5, alpha = 0.8) + 
  facet_wrap(~division, ncol = 2, dir = &amp;quot;v&amp;quot;) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + ylab(&amp;quot;&amp;quot;) + xlab(&amp;quot;Week&amp;quot;) + 
  ggtitle(&amp;quot;Team strength during the 2017/2018 NHL season&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/2018-04-09-a-state-space-model-to-evaluate-sports-team-performance_files/figure-html/unnamed-chunk-8-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;My favorite part about this graph is the distinction between the two Divisions in the Eastern Conference. In the Atlantic Division, Boston, Tampa, and Toronto are three top teams, and apart from the Panthers, the other teams are bottom-dwellers. Meanwhile, nearly every Metropolitan team fits somewhere between the top and bottom of the Atlantic.&lt;/p&gt;
&lt;p&gt;Also impressive – check out Colorado’s slow improvement in the Central. The Avalanche started the year as the league’s third worst team (perception-wise), and are now in the playoffs.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;comparisons-among-teams&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Comparisons among teams&lt;/h2&gt;
&lt;p&gt;One benefit of using a Bayesian approach is that we can more precisely interpret team strength parameters. As an example, let’s look at the posterior distributions of team strength of three NHL teams, the Penguins, Flyers, and Hurricanes. For this task, I focus on the last six weeks of the NHL regular season, to roughly reflect team strength at season’s end.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;teams &amp;lt;- c(&amp;quot;Carolina Hurricanes&amp;quot;, &amp;quot;Pittsburgh Penguins&amp;quot;, &amp;quot;Philadelphia Flyers&amp;quot;)
thetas &amp;lt;- z$theta[20:26, Teams %in% teams, ,]
colors &amp;lt;- teamcolors1$secondary[Teams %in% teams]
team.1 &amp;lt;- data.frame(team_id = teams[1], beta = c(thetas[,1,,]))
team.2 &amp;lt;- data.frame(team_id = teams[2], beta = c(thetas[,2,,]))
team.3 &amp;lt;- data.frame(team_id = teams[3], beta = c(thetas[,3,,]))

df.matchup &amp;lt;- rbind(team.1, team.2, team.3) 
lmin &amp;lt;- quantile(df.matchup$beta, 0.01)
umin &amp;lt;- quantile(df.matchup$beta, 0.99)

df.matchup %&amp;gt;% ggplot(aes(beta, fill = team_id, group = team_id)) + 
  geom_density(alpha = 0.5) + 
  scale_fill_manual(name = NULL, values = colors) + 
  annotate(&amp;quot;text&amp;quot;, x = lmin, y = 4, label = &amp;quot;Hurricanes&amp;quot;,colour = colors[1], size = 5) + 
  annotate(&amp;quot;text&amp;quot;, x = .19, y = 4, label = &amp;quot;Flyers&amp;quot;, colour = colors[2], size = 5) + 
  annotate(&amp;quot;text&amp;quot;, x = umin, y = 4, label = &amp;quot;Penguins&amp;quot;, colour = colors[3], size = 5) +
  ggtitle(&amp;quot;Posterior draws of team strength&amp;quot;) + 
  xlab(&amp;quot;Team strength: log-odds scale&amp;quot;) + ylab(&amp;quot;Density&amp;quot;) + 
  guides(color = FALSE, fill = FALSE) + theme_bw(14) &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;/post/2018-04-09-a-state-space-model-to-evaluate-sports-team-performance_files/figure-html/unnamed-chunk-9-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Above, the Penguins stand out as the best of the three teams. However, although it’s clear the Penguins are better than both the Flyers and the Hurricanes – note the lack of overlap in the density plots – it’s not as clear that the Flyers are better than the Hurricanes.&lt;/p&gt;
&lt;p&gt;Using samples from the posterior distribution, we can be a bit more precise: there’s only about a 1 in 2000 chance that the Hurricanes are better than the Penguins, a 1 in 150 chance that the Flyers are better than the Penguins, and a 1 in 5 chance that the Hurricanes are better than the Flyers.&lt;/p&gt;
&lt;p&gt;But here’s where the NHL is tricky (e.g, random).&lt;/p&gt;
&lt;p&gt;Knowing that the Penguins are better than the Flyers with probability 99.4 percent does not precisely correspond to their chances of actually beating the Flyers when the two teams square off in the 1st round of the 2018 NHL playoffs. In fact, we can use our team strength estimates to sample what a 7-game playoff series could look like, and check how often each team wins. Below, I assume that the Penguins have the home advantage.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;set.seed(0)
flyers.strength &amp;lt;- sample(team.2$beta, 7)
penguins.strength &amp;lt;- sample(team.3$beta, 7)
home.advantage &amp;lt;- sample(z$alpha, 7)
logit.games &amp;lt;- penguins.strength - flyers.strength + 
  home.advantage*c(1, 1, -1, -1, 1, -1, 1)
prob.games &amp;lt;- exp(logit.games)/(1 + exp(logit.games))
penguin.wins &amp;lt;- rbinom(7, 1, prob = prob.games)
do.penguins.win &amp;lt;- sum(penguin.wins) &amp;gt;= 4
do.penguins.win&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] TRUE&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In the example above, the Penguins emerge victorious – congrats &lt;a href=&#34;https://www.nhl.com/penguins/news/penguins-hire-sam-ventura-as-director-of-hockey-research/c-289961770&#34;&gt;Sam&lt;/a&gt;!! – but that doesn’t happen every iteration. Here’s what 10,000 series outcomes would look like:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;set.seed(0)
penguins.sim.wins &amp;lt;- 0
for (i in 1:10000){
  flyers.strength &amp;lt;- sample(team.2$beta, 7)
  penguins.strength &amp;lt;- sample(team.3$beta, 7)
  home.advantage &amp;lt;- sample(z$alpha, 7)
  logit.games &amp;lt;- penguins.strength - flyers.strength + home.advantage*c(1, 1, -1, -1, 1, -1, 1)
  prob.games &amp;lt;- exp(logit.games)/(1 + exp(logit.games))
  penguin.wins &amp;lt;- rbinom(7, 1, prob = prob.games)
  do.penguins.win &amp;lt;- sum(penguin.wins) &amp;gt;= 4
  penguins.sim.wins &amp;lt;- penguins.sim.wins + do.penguins.win
}
sum(penguins.sim.wins)/10000&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] 0.6632&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Our numbers suggest that the Penguins would beat the Flyers roughly 2 out of every 3 times they played a 7-game series. Unsurprisingly, this almost exactly matches the probability implied in sportsbook series odds, which currently price the Penguins at -225 and the Flyers at +195.&lt;/p&gt;
&lt;p&gt;One last thought: how much is the home advantage worth for Pittsburgh? Tweaking the code above, the Flyers would win about 4% more often if they were the team with an extra home game. In other words, only roughly 1 in 25 series outcomes would change were the Penguins to lose their home advantage to the Flyers. This does not appear to be the answer that my Twitter followers &lt;a href=&#34;https://twitter.com/StatsbyLopez/status/983686397818298368&#34;&gt;expected&lt;/a&gt;, as 1 in 25 was the least likely of four outcomes (10, 15, 20, 25).&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;summary&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Summary&lt;/h2&gt;
&lt;p&gt;The above code implements a Bayesian state-space model to etimate team strength in the NHL season using betting market numbers. Though the &lt;code&gt;rjags&lt;/code&gt; package is not the most user-friendly for first-time practitioners, it provides a mechanism for fitting complex models using R. The resulting team strengths are fun to graph and expore, and I encourage you to try it out yourself.&lt;/p&gt;
&lt;p&gt;In future work, there are a few questions that I hope to tackle: Can our model detect if certain teams have better home advantages than others? Was there a so-called &lt;code&gt;Vegas flu&lt;/code&gt;? And when did betting markets begin to pick up on it? What is the probability that any given team is better than any given other team? How did the NHLs shifting postseason structure (to a divisional format) impact postseason chances?&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>On log-loss and scoring the NCAA tournament</title>
      <link>/post/on-log-loss-in-the-ncaa-tournament/</link>
      <pubDate>Mon, 26 Mar 2018 00:00:00 +0000</pubDate>
      
      <guid>/post/on-log-loss-in-the-ncaa-tournament/</guid>
      <description>&lt;p&gt;In 2014, &lt;a href=&#34;www.statsinthewild.com&#34;&gt;Greg&lt;/a&gt; and I won the first annual Kaggle March Madness contest. This led to really cool things happening to a pair of nondescript statisticians that, to the likely detriment of our social lives, happened to know where to find good basketball data while also remembering, on a tight deadline, to enter &lt;code&gt;type = &amp;quot;response&amp;quot;&lt;/code&gt; in our &lt;code&gt;glm&lt;/code&gt; code.&lt;/p&gt;
&lt;p&gt;The Kaggle victory was simultaneously awesome – like &lt;a href=&#34;https://www.nytimes.com/2015/03/22/opinion/sunday/making-march-madness-easy.html&#34;&gt;New York Times&lt;/a&gt; awesome – and embarassing, as Greg and I realized how lucky we were to have finished on top.&lt;/p&gt;
&lt;p&gt;To wit:&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;p&gt;Even if we assumed that our model contained the true probabilities for every 2014 NCAA tournament game, &lt;a href=&#34;https://statsbylopez.files.wordpress.com/2013/08/jqas-2014-0058.pdf&#34;&gt;there was a better chance that our submission finished outside the top-10&lt;/a&gt; than inside it. It’s humbling to know that you can have precise numbers for every possible game, and in all likelhood, not have increased your chances of winning by much more than a factor of five.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;We are pretty sure we actually mis-typed Ohio State as Ohio during our data wrangling process, thus giving what was a pretty good Ohio State team a fairly mediocre ranking. This helped us immensely when Ohio State lost to Dayton in a first round upset. Note the caveat that I am “pretty sure” this was the case; honestly, that’s about as good as I can get looking at our old files.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;We won on a disqualification, when someone who had submitted multiple entries was banned from winning.&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;It’s a few years later now, but the luck required for us to have won the Kaggle contest has stayed with us. And it’s an important backdrop for the point of this post – &lt;strong&gt;it’s time for Kaggle to change its scoring rule&lt;/strong&gt;.&lt;/p&gt;
&lt;div id=&#34;log-loss-as-a-scoring-rule.&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Log loss as a scoring rule.&lt;/h2&gt;
&lt;p&gt;Kaggle scores contest submissions using &lt;a href=&#34;https://www.r-bloggers.com/making-sense-of-logarithmic-loss/&#34;&gt;log-loss (LL)&lt;/a&gt;, and allows participants two unique submissions. As a scoring rule, LL boasts a few critical properties:&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;p&gt;LL is a &lt;a href=&#34;https://www.stat.washington.edu/raftery/Research/PDF/Gneiting2007jasa.pdf&#34;&gt;proper scoring rule&lt;/a&gt; – that is, in expectation, the best log-loss is obtained by reporting the true probabilities.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Penalties are disproportionately larger for high-confident decisions that go wrong. As an example, giving Virginia a 97% probability against UMBC results in a LL of 3.5 (higher is worse), while a coin flip of 0.5 scores only a LL of 0.7. But note how much better 95% would have been – (LL of 3) – relative to a 99% submission (LL of 4.6).&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In the long run of hypothetical NCAA tournament games between a fixed number of Kaggle participants, LL makes sense as a scoring system. But the NCAA tournament scores only 63 games, and the number of Kaggle participants has nearly quadrupled in the last four years. That’s a tricky setting moving forward.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;limitations-of-log-loss&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Limitations of Log loss&lt;/h2&gt;
&lt;p&gt;There are a few important limitations to log loss as a scoring rule with NCAA tournament data (see Christopher Long’s post &lt;a href=&#34;angrystatistician.blogspot.com/2017/04/why-does-kaggle-use-log-loss.html&#34;&gt;here&lt;/a&gt; for more).&lt;/p&gt;
&lt;p&gt;First, the small sample of games means that submissions maximizing your chance of finishing first are &lt;em&gt;not&lt;/em&gt; the same as those minimizing your expected log-loss. The 2017 winner, Andrew Landgraf, has a &lt;a href=&#34;http://blog.kaggle.com/2017/05/19/march-machine-learning-mania-1st-place-winners-interview-andrew-landgraf/&#34;&gt;fascinating interview&lt;/a&gt; in which he identifies that his strategy was to &lt;em&gt;not&lt;/em&gt; choose his most accurate probabilities. Instead, Andrew created hypothetical distributions of what he thought other participants would submit, and used these simulations to derive an optimal set of predictions.&lt;/p&gt;
&lt;p&gt;Second, and along similar lines, there is now a massive, and growing, incentive to predict upsets. With the 2014 data, I estimated that, under a few assumptions, picking a single first round upset with probability 1 would have increased our chances of winning from about 1 in 40 to about 1 in 15. That’s a massive gain, and its a strategy that several recent teams inside the top-5 have employed. As one example, check out the team BAYZ – in 2016, BAYZ finished &lt;a href=&#34;https://www.kaggle.com/c/march-machine-learning-mania-2016/leaderboard&#34;&gt;third overall&lt;/a&gt;. &lt;a href=&#34;https://www.kaggle.com/c/march-machine-learning-mania-2017/leaderboard&#34;&gt;Last year&lt;/a&gt; and &lt;a href=&#34;https://www.kaggle.com/c/mens-machine-learning-competition-2018/leaderboard&#34;&gt;this year&lt;/a&gt;, however, BAYZ will finish in the bottom 15. Did BAYZ get worse? No. But it is picking upsets, and both living and dying with the results. And the more teams that pick upsets, the more of an uphill fight that those who aren’t picking upsets will have. Note that even though we know it makes our chances of winning worse, Greg and I have opted against picking upsets.&lt;/p&gt;
&lt;p&gt;Third, combining LL with the prize structure of Kaggle – only the top few finishers pay out, and the prizes are massive – encourages cheating, where people submit multiple entries under different names. As mentioned above, Greg and I only won when someone else got disqualified for multiple entries. Why did this person enter multiple times? He wanted to game LL by choosing upsets. How did this person enter multiple times? He entered the same submission, just changing one unique upset on each sheet. And why did he finish in front of us? Because Mercer beat Duke in 2014, and so instead of a typical LL penalty of about 3 (&lt;code&gt;log(0.05) = -3&lt;/code&gt;), his penalty for the Duke/Mercer game was 0. Fortunately, the good folks at Kaggle were able to catch that cheater and drop him from the leaderboard … but I’m not so sure that will always be the case moving forward.&lt;/p&gt;
&lt;p&gt;Fourth, and finally, in allowing &lt;em&gt;two&lt;/em&gt; entries, the current Kaggle rules are essentially doubling the options that entrants have to pick upsets. Like several other participants, Greg and I enter the same model, changing only the final game: on one sheet, we enter 1’s for the teams on the left side of the bracket, and on the other sheet, we enter 1’s for teams on the right side of the bracket. This ad-hoc scoring is not without motivation – using simulations in the 2014 tournament, I estimated that our chances of winning roughly doubled when employing this strategy – but the overall strategy as a whole does seem disingenous.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;what-other-scoring-rules-are-possible&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;What other scoring rules are possible?&lt;/h2&gt;
&lt;p&gt;In an ideal world, Kaggle would reward participants for accuracy and not luck. The current set-up, however, disproportionately rewards upsets and contrarion strategies. In place, here are a few options to consider.&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Predict the point differential, and score using RMSE or MAE.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Point differential is commonly mentioned in the Kaggle forums as an alternative outcome, as it boasts a few benefits over LL. First, upset-based strategies are not as obvious. If Virginia is a 20-point favorite over UMBC, a rogue Kaggler predicting a 41-point Virginia win would be taking the same risk as one predicting a one-point UMBC win. Second, point-differential tells us more about the participating teams. This is why statistical models using point differential as an outcome almost always perform better than ones that use win-loss results as an outcome.&lt;/p&gt;
&lt;p&gt;Note that a common response to this suggestion is “I don’t want results being swayed by bench players in garbage time.” However, these swings are minor in comparison to the enormous swings that are already currently occuring with won-loss outcomes. As an example, a Kaggler with Loyola 0.51 &amp;gt; Miami assuredly had the better prediction that one with Loyola 0.99 &amp;gt; Miami (Loyola won on a last second shot). However, the second Kaggler receives a better score than the first. This does not seem fair.&lt;/p&gt;
&lt;ol start=&#34;2&#34; style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Predict the point differential, score using RMSE or MAE, and merge with current LL predictions.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Having two scoring rules would make the contest a bit more challenging to enter, but the benefit of having multiple approaches for measuring model performance could be worth it. In this instance, whoever finishes with the best average rank under each scoring rule would be the winner.&lt;/p&gt;
&lt;ol start=&#34;3&#34; style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Predict point differential and uncertainty in that point differential, and score using the normal distribution.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I think this is my preferred scoring rule, and it is inspired by Micah’s &lt;a href=&#34;http://hockeyviz.com/txt/predictionContest1718&#34;&gt;Sour Candy Contest&lt;/a&gt; in the NHL.&lt;/p&gt;
&lt;p&gt;In this set-up, participants submit a prediction for point differential as well as a standard deviation to reflect uncertainty in that point differential. The score associated with each game combines the predicted result, the observed result, and the standard deviation, by estimating the likelihood that the observed result occurs given the . Though it could be rescaled, the maximum score for any given game is 1 – this occurs when a prediction is perfectly accurate and the proposed standard deviation is 0.&lt;/p&gt;
&lt;p&gt;As a hypothetical, consider Loyola versus Miami, which finished as a two-point Loyola win.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Submission 1: &lt;span class=&#34;math inline&#34;&gt;\(\hat{\mu}_1\)&lt;/span&gt; = 2, &lt;span class=&#34;math inline&#34;&gt;\(\hat{\sigma}\)&lt;/span&gt; = 1.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>The impact of make-up calls is probably bigger than you think</title>
      <link>/post/the-impact-of-make-up-calls-is-probably-bigger-than-you-think/</link>
      <pubDate>Fri, 16 Mar 2018 00:00:00 +0000</pubDate>
      
      <guid>/post/the-impact-of-make-up-calls-is-probably-bigger-than-you-think/</guid>
      <description>

&lt;p&gt;One of the more reliable indicators of which NHL team is likely to get the next power play has little to do with score or style of play. Instead, it&amp;rsquo;s been shown repeatedly (&lt;a href=&#34;https://fivethirtyeight.com/features/hockey-refs-are-out-to-get-you-if-they-already-got-the-other-guy/&#34; target=&#34;_blank&#34;&gt;Ex 1&lt;/a&gt;, &lt;a href=&#34;http://people.stat.sfu.ca/~tim/papers/penalty.pdf&#34; target=&#34;_blank&#34;&gt;Ex 2&lt;/a&gt;) that referees call a substantially higher number of make-up penalties than would otherwise be expected in order to maintain an overall even number of violations on each team. Call it a &lt;a href=&#34;https://creativematter.skidmore.edu/cgi/viewcontent.cgi?article=1004&amp;amp;context=math_fac_schol&#34; target=&#34;_blank&#34;&gt;&lt;em&gt;biased impartiality&lt;/em&gt;&lt;/a&gt; &amp;ndash; in order to appear impartial by game&amp;rsquo;s end, ref&amp;rsquo;s let previous decisions drive future ones.&lt;/p&gt;

&lt;p&gt;A common line of reasoning behind call reversals is that referees would prefer to $not$ be part of the final narrative as to why a particular team won or lost. If each team has a relatively similar number of power plays, media and fans clamoring that one team was favored would have less support. Turns out, however, that by evening up penalty calls, hockey ref&amp;rsquo;s are impacting the same game narratives that they are trying to avoid being a part of. In this post, I&amp;rsquo;ll both confirm the existance of make-up calls and extend a similar analysis to look at the impact of make-up calls on game outcomes.&lt;/p&gt;

&lt;h2 id=&#34;the-make-up-call&#34;&gt;The make-up call&lt;/h2&gt;

&lt;p&gt;Claiming that a call in any sport is due to anything besides an unbiased referee assessment is a non-trivial task. Fortunately, hockey boasts several settings that make looking for make-up calls somewhat feasible. Game&amp;rsquo;s are often tied, and looking at penalties in tied-game states can avoid results being impacted by changes in style of play due to the score. Moreover, with an average of about eight minors a game &amp;ndash; most of them judgement calls &amp;ndash;  there&amp;rsquo;s a large enough sample size within each game on which to evaluate ref choices.&lt;/p&gt;

&lt;p&gt;Here&amp;rsquo;s an initial chart comparing the penalty differential between each team at the end of the first period (y-axis, where positive means more penalties) to penalty differential over the remainder of the game (shown in the darkness and color of the grid).&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;#fn:1&#34;&gt;1&lt;/a&gt;&lt;/sup&gt; The x-axis corresponds to the home team&amp;rsquo;s estimated pre-game win probability, calculated using odds implied by betting markets (you can get that data &lt;a href=&#34;https://github.com/bigfour/competitiveness/blob/master/data/bigfour_public.rda&#34; target=&#34;_blank&#34;&gt;here&lt;/a&gt;). Accounting for relative team talent is potentially important, as its a variable that&amp;rsquo;s quite possibly linked to penalty calls and team aggressiveness. Only games that were tied at the end of the first period are included in this chart &amp;ndash; the data goes from the 05-06 to 15-16 regular seasons.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/img/makeupF1.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;When home teams have two more infractions than their opponent at the end of the first period, they average roughly 0.8 fewer infractions the rest of the game. Alternatively, when home teams have two fewer penalties at the end of the first, they average about 0.5 more violations in periods 2 and 3. The difference between having more and fewer penalties in tied games is quite significant from a statistical perspective. Of course, if you had read a few of the links above, you probably would have guessed that there would be this type of impact. But the effect size (an extra 1.3 power plays in 2 periods), as well as the shading consistency of the chart above, seemed noteworthy.&lt;/p&gt;

&lt;h2 id=&#34;the-impact-of-the-make-up-call&#34;&gt;The impact of the make-up call&lt;/h2&gt;

&lt;p&gt;A make-up calls is all well and good until one team loses a game because of it.&lt;/p&gt;

&lt;p&gt;To check how future games are impacted by make-up calls, I used a chart similar to the one shown above. In this one, however, shading reflects the percent of games eventually won by the home team.&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;#fn:2&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/img/makeupF2.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;In this version, the shading is reversed &amp;ndash; more first period penalties are linked to an increased win rate, just as fewer penalties are linked to a decreased win rate. Again, remember that we&amp;rsquo;re only looking at tied games, and we&amp;rsquo;re accounting for how good each team is!&lt;/p&gt;

&lt;p&gt;Altogether, when the game is expected to be a relative toss-up, the difference between having two more first period penalties and two fewer first period penalties is about 7 or 8 percentage points in terms of the home team&amp;rsquo;s chances. The effect is a bit larger when the home team is not expected to win, with differences between fewer and more first period worth an estimated 10 percentage points.&lt;/p&gt;

&lt;p&gt;While this may seem like a relatively minor change, the fact that there&amp;rsquo;s $any$ change in win rate based on prior penalties is curious given that we&amp;rsquo;re only looking at tied games. Additionally, we may be underestimating the impact of make-up calls &amp;ndash; if a team had more first period penalties, it would have likewise been more likely to start the second period on a penalty kill, a quirk that I did not account for above. Further, this isn&amp;rsquo;t a peculiar set of games  &amp;ndash; about a third of NHL games end the first period tied. Finally, although it&amp;rsquo;d require further assumptions with respect to playing style, it&amp;rsquo;s also likely that make-up calls have an impact on games that aren&amp;rsquo;t tied.&lt;/p&gt;

&lt;p&gt;One limitation of this post is that, in using observational data, it is feasible that there&amp;rsquo;s something else responsible for the link between first period penalty differential and game outcomes. One possible alternative is that teams that have taken penalties suddenly feel the need to be more aggressive, which then leads to more natural reversals masquerading as make-up calls. However, for tied games, I can&amp;rsquo;t imagine that the revenge factor looms too large. Further, in &lt;a href=&#34;https://creativematter.skidmore.edu/cgi/viewcontent.cgi?article=1004&amp;amp;context=math_fac_schol&#34; target=&#34;_blank&#34;&gt;previous work&lt;/a&gt;, I found that penalty reversals were, if anything, higher in the postseason, where there is almost no desire for revenge (at least via penalties).&lt;/p&gt;

&lt;p&gt;If you are curious about the coding for the project, I used play-by-play data via the now archived &lt;a href=&#34;https://cran.r-project.org/web/packages/nhlscrapr/index.html&#34; target=&#34;_blank&#34;&gt;nhlscrapr&lt;/a&gt; package in R. Matching minors, as well as all major penalties, were dropped. The code for all figures, models, and numbers is &lt;a href=&#34;https://github.com/statsbylopez/BlogPosts/blob/master/NHL_predict_penaltydiff.R&#34; target=&#34;_blank&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&#34;footnotes&#34;&gt;

&lt;hr /&gt;

&lt;ol&gt;
&lt;li id=&#34;fn:1&#34;&gt;I used a generalized additive model (GAM) of penalty differential as a factor of both home team win probability and first period penalty differential. In this and the example below, first period penalty differential was a significant predictor. GAMs make sense in this and other examples, as the true model fit with penalty outcomes is unknown.
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:1&#34;&gt;&lt;sup&gt;^&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li id=&#34;fn:2&#34;&gt;Same model as above, now with a binary outcome.
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:2&#34;&gt;&lt;sup&gt;^&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
    </item>
    
  </channel>
</rss>
